# Phase 18: 全链路测试与发布就绪（详细实施计划）

> **状态:** ⬜ 未开始  
> **进度追踪:** 查看 `TODO.md`  
> **前置条件:** Phase 17 完成  

## 目标

1. 全链路功能测试通过。  
2. 并发/失败/恢复场景稳定。  
3. 安全、文档、发布流程齐备。  

## 非目标

- 不引入新功能。  

## 参考资料

- `tests/e2e/workflow_test.rs`  
- `docs/ops`（如已存在）  

---

## 新手准备清单

1) 确认所有测试可运行：  
```
cargo test --workspace
pnpm test -- --run
```

2) 了解发布流程（如已有文档）：  
- 备份  
- 升级  
- 回滚  

---

## Task 18.1: 端到端全流程测试（创建->启动->执行->合并）

**状态:** ⬜ 未开始  

**目标:**  
覆盖完整 workflow 生命周期。

**涉及文件:**  
- 修改: `tests/e2e/workflow_test.rs`  

**实施步骤（新手可逐步照做）:**  

Step 18.1.1: 创建 workflow  
- 通过 API 创建  

Step 18.1.2: 启动 workflow  
- 断言状态从 ready -> running  

Step 18.1.3: 模拟任务完成  
- 更新 task 状态  
- 触发 merge terminal  

**验收标准:**  
- 完整流程测试通过  

---

## Task 18.2: 并发/失败/恢复场景测试

**状态:** ⬜ 未开始  

**目标:**  
确保复杂场景稳定。

**涉及文件:**  
- 新增: `tests/e2e/workflow_recovery_test.rs`  

**实施步骤（新手可逐步照做）:**  

Step 18.2.1: 并发任务测试  
- 创建 3 个任务并行  

Step 18.2.2: 失败测试  
- 强制 1 个终端失败  

Step 18.2.3: 重启恢复测试  
- 模拟服务重启  
- 检查状态恢复  

**验收标准:**  
- 并发/失败/恢复均通过  

---

## Task 18.3: 性能与稳定性压测（终端/WS/DB）

**状态:** ⬜ 未开始  

**目标:**  
验证高并发稳定性。

**涉及文件:**  
- 新增: `scripts/load-test/workflow_load.js`  

**实施步骤（新手可逐步照做）:**  

Step 18.3.1: 编写负载脚本  
- 并发启动 20 个终端  

Step 18.3.2: 记录性能指标  
- CPU/内存/响应时间  

Step 18.3.3: 优化瓶颈  
- 若响应过慢，定位热点  

**验收标准:**  
- 目标并发无崩溃  

---

## Task 18.4: 安全与配置审计（密钥/权限/日志）

**状态:** ⬜ 未开始  

**目标:**  
确保无敏感信息泄露。

**涉及文件:**  
- 修改: `crates/db/src/models/workflow.rs`  
- 修改: `crates/server/src/routes/config.rs`  

**实施步骤（新手可逐步照做）:**  

Step 18.4.1: 校验 API Key 加密  
- 确认 `orchestrator_api_key` 不序列化  

Step 18.4.2: 检查日志  
- 禁止打印密钥  

Step 18.4.3: 权限边界  
- 非管理员不能查看他人 workflow  

**验收标准:**  
- 无敏感信息泄露  

---

## Task 18.5: 使用文档与运维手册完善

**状态:** ⬜ 未开始  

**目标:**  
新用户可按文档部署与使用。

**涉及文件:**  
- 修改: `README.md`  
- 新增: `docs/ops/runbook.md`  

**实施步骤（新手可逐步照做）:**  

Step 18.5.1: 补充安装步骤  
- 环境依赖  
- 启动命令  

Step 18.5.2: 补充排错指南  
- 终端无输出  
- CLI 未安装  

Step 18.5.3: 补充升级/回滚说明  

**验收标准:**  
- 按文档可完成部署  

---

## Task 18.6: 发布与回滚清单（版本/迁移/备份）

**状态:** ⬜ 未开始  

**目标:**  
形成可执行的发布流程。

**涉及文件:**  
- 新增: `docs/plans/release-checklist.md`  

**实施步骤（新手可逐步照做）:**  

Step 18.6.1: 定义版本策略  
- 语义化版本  

Step 18.6.2: 定义备份策略  
- DB 备份  
- 配置备份  

Step 18.6.3: 形成 checklist  
- 测试通过  
- 文档更新  

**验收标准:**  
- checklist 可直接执行  
