# Phase 18.5 TDD å®æ–½è®¡åˆ’

> **åˆ›å»ºæ—¥æœŸ:** 2026-01-31
> **æ›´æ–°æ—¥æœŸ:** 2026-02-04
> **å·¥ä½œåŒº:** E:\GitCortex-phase-18.5
> **åˆ†æ”¯:** feature/phase-18.5-design-alignment
> **çŠ¶æ€:** ğŸ”¶ è¿›è¡Œä¸­ï¼ˆé˜¶æ®µ 1-4 å·²å®Œæˆï¼Œé˜¶æ®µ 5-6 å¾…å®Œæˆï¼‰

---

## 1. å®æ–½é¡ºåºï¼ˆæŒ‰ä¾èµ–å…³ç³»ï¼‰

### é˜¶æ®µ 1: åŸºç¡€è®¾æ–½å±‚ï¼ˆP0-4, P0-5ï¼‰
**ä¼˜å…ˆçº§:** æœ€é«˜ - åç»­æ‰€æœ‰åŠŸèƒ½ä¾èµ–æ­¤åŸºç¡€

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ | æµ‹è¯•å…ˆè¡Œ |
|------|------|------|----------|
| 1.1 | æ‰©å±• WebSocket æ¶ˆæ¯ç±»å‹å®šä¹‰ | `shared/types.ts` (ç”Ÿæˆ), `frontend/src/types/websocket.ts` | âœ… |
| 1.2 | åˆ›å»º wsStore - WebSocket è¿æ¥ç®¡ç† | `frontend/src/stores/wsStore.ts` | âœ… |
| 1.3 | åˆ›å»º workflowStore - å·¥ä½œæµçŠ¶æ€ | `frontend/src/stores/workflowStore.ts` | âœ… |
| 1.4 | åˆ›å»º terminalStore - ç»ˆç«¯çŠ¶æ€ä¸è¾“å‡º | `frontend/src/stores/terminalStore.ts` | âœ… |
| 1.5 | åˆ›å»º wizardStore - å‘å¯¼è¡¨å•æ•°æ® | `frontend/src/stores/wizardStore.ts` | âœ… |
| 1.6 | åˆ›å»º modelStore - æ¨¡å‹é…ç½® | `frontend/src/stores/modelStore.ts` | âœ… |
| 1.7 | å®ç°å¿ƒè·³æœºåˆ¶ä¸æ–­çº¿é‡è¿ | `frontend/src/stores/wsStore.ts` | âœ… |

### é˜¶æ®µ 2: äº¤äº’æ ¸å¿ƒï¼ˆP0-2ï¼‰
**ä¼˜å…ˆçº§:** é«˜ - è°ƒè¯•è§†å›¾æ˜¯æ ¸å¿ƒåŠŸèƒ½

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ | æµ‹è¯•å…ˆè¡Œ |
|------|------|------|----------|
| 2.1 | ç»Ÿä¸€è°ƒè¯•è§†å›¾å…¥å£ | `frontend/src/pages/WorkflowDebugPage.tsx` | âœ… |
| 2.2 | æ¥å…¥ TerminalEmulator ç»„ä»¶ | `frontend/src/components/debug/TerminalDebugView.tsx` | âœ… |
| 2.3 | å®ç° PTY WebSocket è¿æ¥ | `frontend/src/components/terminal/TerminalEmulator.tsx` | âœ… |
| 2.4 | æ”¯æŒç»ˆç«¯é‡è¿ä¸æ¸…å± | `frontend/src/stores/terminalStore.ts` | âœ… |

### é˜¶æ®µ 3: çœ‹æ¿æ‹–æ‹½ï¼ˆP0-3ï¼‰
**ä¼˜å…ˆçº§:** é«˜ - ä»»åŠ¡ç®¡ç†æ ¸å¿ƒäº¤äº’

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ | æµ‹è¯•å…ˆè¡Œ |
|------|------|------|----------|
| 3.1 | å®‰è£… @dnd-kit ä¾èµ– | `package.json` | - |
| 3.2 | å®ç°åˆ—å†…æ‹–æ‹½æ’åº | `frontend/src/components/board/WorkflowKanbanBoard.tsx` | âœ… |
| 3.3 | å®ç°è·¨åˆ—æ‹–æ‹½çŠ¶æ€æ›´æ–° | `frontend/src/components/board/WorkflowKanbanBoard.tsx` | âœ… |
| 3.4 | å®ç°ä¹è§‚æ›´æ–°ä¸å›æ»š | `frontend/src/hooks/useTaskMutations.ts` | âœ… |
| 3.5 | æ·»åŠ æ‹–æ‹½è§†è§‰åé¦ˆ | `frontend/src/components/board/TaskCard.tsx` | âœ… |

### é˜¶æ®µ 4: æµç¨‹æ‰“é€šï¼ˆP0-1, P0-6, P0-7ï¼‰
**ä¼˜å…ˆçº§:** é«˜ - æ¢å¤å®Œæ•´å¯ç”¨æ€§

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ | æµ‹è¯•å…ˆè¡Œ |
|------|------|------|----------|
| 4.1 | ç»ˆç«¯æ•°é‡æ‰©å±•åˆ° 1-10 | `frontend/src/components/workflow/steps/Step2Tasks.tsx` | âœ… |
| 4.2 | åŒæ­¥ Step4 ç»ˆç«¯ç”Ÿæˆé€»è¾‘ | `frontend/src/components/workflow/steps/Step4Terminals.tsx` | âœ… |
| 4.3 | å®ç°æ¨¡å‹åˆ—è¡¨ API è°ƒç”¨ | `frontend/src/components/workflow/steps/Step3Models.tsx` | âœ… |
| 4.4 | å®ç°æ¨¡å‹éªŒè¯ API è°ƒç”¨ | `frontend/src/components/workflow/steps/Step3Models.tsx` | âœ… |
| 4.5 | CLI ç±»å‹æ‰©å±•åˆ° 9 ä¸ª | `frontend/src/components/workflow/constants.ts` | âœ… |
| 4.6 | CLI ä¸ BaseCodingAgent æšä¸¾æ˜ å°„ | `frontend/src/components/workflow/constants.ts` | âœ… |

### é˜¶æ®µ 5: æµç¨‹ä¸€è‡´æ€§ï¼ˆP1-1 ~ P1-7ï¼‰
**ä¼˜å…ˆçº§:** ä¸­

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ | æµ‹è¯•å…ˆè¡Œ |
|------|------|------|----------|
| 5.1 | Git æäº¤è§„èŒƒå¯¹é½ METADATA æ ¼å¼ | `frontend/src/components/workflow/constants.ts` | âœ… |
| 5.2 | è·¯ç”±ç»“æ„æ”¹ä¸ºåˆ†æ­¥è·¯ç”± | `frontend/src/App.tsx`, `frontend/src/pages/` | âœ… |
| 5.3 | è®¾ç½®é¡µé¢ç»“æ„å¯¹é½ | `frontend/src/App.tsx`, `frontend/src/pages/Settings/` | âœ… |
| 5.4 | è§†å›¾åˆ‡æ¢å¯¼èˆªè¡¥é½ | `frontend/src/components/layout/NewDesignLayout.tsx` | âœ… |
| 5.5 | ç»ˆç«¯æ´»åŠ¨é¢æ¿åŠŸèƒ½è¡¥å…¨ | `frontend/src/components/board/TerminalActivityPanel.tsx` | âœ… |
| 5.6 | æµæ°´çº¿è§†å›¾ä¿¡æ¯è¡¥å…¨ | `frontend/src/components/pipeline/TaskPipeline.tsx` | âœ… |
| 5.7 | Step4/Step5 äº¤äº’å¯¹é½ | `frontend/src/components/workflow/steps/Step4Terminals.tsx`, `Step5Commands.tsx` | âœ… |

### é˜¶æ®µ 6: ä½“éªŒè¡¥é½ï¼ˆP2ï¼‰
**ä¼˜å…ˆçº§:** ä½

| åºå· | ä»»åŠ¡ | æ–‡ä»¶ |
|------|------|------|
| 6.1 | StatusBar/OrchestratorHeader åŠ¨æ€æ•°æ® | å¤šæ–‡ä»¶ |
| 6.2 | TaskCard/TerminalDots çŠ¶æ€åŒºåˆ† | å¤šæ–‡ä»¶ |
| 6.3 | Step0-Step6 UI ç»†èŠ‚å¯¹é½ | å¤šæ–‡ä»¶ |
| 6.4 | è°ƒè¯•è§†å›¾ UI è¡¥å…¨ | å¤šæ–‡ä»¶ |
| 6.5 | æµæ°´çº¿è§†å›¾ UI è¡¥å…¨ | å¤šæ–‡ä»¶ |

---

## 2. è¯¦ç»†å®æ–½æ–¹æ¡ˆ

### 2.1 é˜¶æ®µ 1: åŸºç¡€è®¾æ–½å±‚

#### Task 1.1: æ‰©å±• WebSocket æ¶ˆæ¯ç±»å‹

**å½“å‰çŠ¶æ€:**
```typescript
// shared/types.ts:233
export type WsMessage =
  | { "type": "input", data: string }
  | { "type": "output", data: string }
  | { "type": "resize", cols: number, rows: number }
  | { "type": "error", message: string };
```

**ç›®æ ‡çŠ¶æ€:**
```typescript
// ç»Ÿä¸€æ¶ˆæ¯åè®®
export interface WsMessageBase {
  type: string;
  payload: unknown;
  timestamp: string;
  id: string;
}

// äº‹ä»¶ç±»å‹å‘½åç©ºé—´
export type WsEventType =
  | `workflow.${string}`    // workflow.created, workflow.started, workflow.completed
  | `terminal.${string}`    // terminal.output, terminal.input, terminal.resize
  | `git.${string}`         // git.commit, git.push, git.merge
  | `orchestrator.${string}` // orchestrator.instruction, orchestrator.response
  | `system.${string}`;     // system.heartbeat, system.error
```

**æ³¨æ„:** `shared/types.ts` æ˜¯ç”Ÿæˆæ–‡ä»¶ï¼Œéœ€è¦ä¿®æ”¹åç«¯ `crates/core/src/bin/generate_types.rs`

**æµ‹è¯•ç”¨ä¾‹:**
```typescript
// frontend/src/types/__tests__/websocket.test.ts
describe('WsMessage types', () => {
  it('should validate workflow event messages', () => {});
  it('should validate terminal event messages', () => {});
  it('should validate system heartbeat messages', () => {});
  it('should have timestamp and id fields', () => {});
});
```

#### Task 1.2: åˆ›å»º wsStore

**æ–‡ä»¶:** `frontend/src/stores/wsStore.ts`

**æ¥å£è®¾è®¡:**
```typescript
interface WsStore {
  // çŠ¶æ€
  connectionStatus: 'disconnected' | 'connecting' | 'connected' | 'reconnecting';
  lastHeartbeat: Date | null;
  reconnectAttempts: number;

  // æ“ä½œ
  connect: (url: string) => void;
  disconnect: () => void;
  send: (message: WsMessage) => void;
  subscribe: (eventType: string, handler: (payload: unknown) => void) => () => void;

  // å†…éƒ¨
  _ws: WebSocket | null;
  _handlers: Map<string, Set<(payload: unknown) => void>>;
  _heartbeatInterval: NodeJS.Timeout | null;
}
```

**æµ‹è¯•ç”¨ä¾‹:**
```typescript
describe('wsStore', () => {
  it('should connect to WebSocket server', () => {});
  it('should reconnect on disconnect with exponential backoff', () => {});
  it('should send heartbeat every 30 seconds', () => {});
  it('should dispatch messages to correct handlers', () => {});
  it('should clean up on disconnect', () => {});
});
```

#### Task 1.3-1.6: åˆ›å»ºæ ¸å¿ƒ Stores

**workflowStore:**
```typescript
interface WorkflowStore {
  workflows: Map<string, WorkflowDetailDto>;
  activeWorkflowId: string | null;

  setActiveWorkflow: (id: string) => void;
  updateWorkflow: (id: string, updates: Partial<WorkflowDetailDto>) => void;
  updateTaskStatus: (workflowId: string, taskId: string, status: string) => void;
}
```

**terminalStore:**
```typescript
interface TerminalStore {
  terminals: Map<string, TerminalState>;
  activeTerminalId: string | null;

  setActiveTerminal: (id: string) => void;
  appendOutput: (terminalId: string, data: string) => void;
  clearOutput: (terminalId: string) => void;
  updateStatus: (terminalId: string, status: string) => void;
}
```

**wizardStore:**
```typescript
interface WizardStore {
  currentStep: number;
  config: WizardConfig;
  errors: Record<string, string>;

  setStep: (step: number) => void;
  updateConfig: (updates: Partial<WizardConfig>) => void;
  setErrors: (errors: Record<string, string>) => void;
  reset: () => void;
}
```

**modelStore:**
```typescript
interface ModelStore {
  models: ModelConfig[];
  availableModels: Map<string, string[]>; // apiType -> models
  isLoading: boolean;

  fetchModels: (apiType: string, apiKey: string) => Promise<void>;
  verifyModel: (config: ModelConfig) => Promise<boolean>;
  addModel: (model: ModelConfig) => void;
  removeModel: (id: string) => void;
}
```

### 2.2 é˜¶æ®µ 2: è°ƒè¯•è§†å›¾äº¤äº’åŒ–

#### Task 2.1-2.4: ç»Ÿä¸€è°ƒè¯•è§†å›¾

**å½“å‰é—®é¢˜:**
- `frontend/src/components/debug/TerminalDebugView.tsx` - çº¯è¯¦æƒ…é¢æ¿
- `frontend/src/components/terminal/TerminalDebugView.tsx` - äº¤äº’å¼ï¼ˆæœªä½¿ç”¨ï¼‰
- `frontend/src/pages/WorkflowDebugPage.tsx` - ä½¿ç”¨çº¯è¯¦æƒ…é¢æ¿

**ä¿®å¤æ–¹æ¡ˆ:**
1. å°† `WorkflowDebugPage.tsx` åˆ‡æ¢åˆ°ä½¿ç”¨ `TerminalEmulator` ç»„ä»¶
2. ä¿ç•™è¯¦æƒ…é¢æ¿ä½œä¸ºä¾§è¾¹æ ä¿¡æ¯å±•ç¤º
3. ä¸»åŒºåŸŸä½¿ç”¨ xterm.js äº¤äº’å¼ç»ˆç«¯

**æµ‹è¯•ç”¨ä¾‹:**
```typescript
describe('TerminalDebugView', () => {
  it('should render xterm terminal', () => {});
  it('should connect to PTY WebSocket', () => {});
  it('should handle terminal resize', () => {});
  it('should reconnect on connection loss', () => {});
  it('should display terminal details in sidebar', () => {});
});
```

### 2.3 é˜¶æ®µ 3: çœ‹æ¿æ‹–æ‹½

#### Task 3.1-3.5: å®ç° dnd-kit æ‹–æ‹½

**ä¾èµ–å®‰è£…:**
```bash
pnpm add @dnd-kit/core @dnd-kit/sortable @dnd-kit/utilities
```

**å®ç°è¦ç‚¹:**
1. ä½¿ç”¨ `DndContext` åŒ…è£¹çœ‹æ¿
2. æ¯åˆ—ä½¿ç”¨ `SortableContext`
3. ä»»åŠ¡å¡ç‰‡ä½¿ç”¨ `useSortable` hook
4. æ‹–æ‹½ç»“æŸæ—¶è°ƒç”¨ API æ›´æ–°çŠ¶æ€

**æµ‹è¯•ç”¨ä¾‹:**
```typescript
describe('WorkflowKanbanBoard', () => {
  it('should render draggable task cards', () => {});
  it('should allow drag within same column', () => {});
  it('should allow drag across columns', () => {});
  it('should update task status on cross-column drop', () => {});
  it('should rollback on API failure', () => {});
  it('should show drag overlay during drag', () => {});
});
```

### 2.4 é˜¶æ®µ 4: æµç¨‹æ‰“é€š

#### Task 4.1-4.2: ç»ˆç«¯æ•°é‡æ‰©å±•

**å½“å‰:**
```typescript
const TERMINAL_COUNT_OPTIONS = [1, 2, 3];
```

**ç›®æ ‡:**
```typescript
const TERMINAL_COUNT_OPTIONS = [1, 2, 3, 4, 5];
const TERMINAL_COUNT_MIN = 1;
const TERMINAL_COUNT_MAX = 10;

// UI: å¿«æ·æŒ‰é’® + è‡ªå®šä¹‰è¾“å…¥
<div className="flex gap-2">
  {TERMINAL_COUNT_OPTIONS.map(count => (
    <button key={count} onClick={() => setCount(count)}>{count}</button>
  ))}
  <input
    type="number"
    min={TERMINAL_COUNT_MIN}
    max={TERMINAL_COUNT_MAX}
    placeholder="è‡ªå®šä¹‰"
  />
</div>
```

**æµ‹è¯•ç”¨ä¾‹:**
```typescript
describe('Step2Tasks terminal count', () => {
  it('should allow selecting 1-5 via quick buttons', () => {});
  it('should allow custom input 1-10', () => {});
  it('should validate min/max bounds', () => {});
  it('should show error for invalid values', () => {});
});
```

#### Task 4.3-4.4: æ¨¡å‹ API å®ç°

**API ç«¯ç‚¹:**
- `GET /api/models/list?apiType={type}&apiKey={key}` - è·å–å¯ç”¨æ¨¡å‹
- `POST /api/models/verify` - éªŒè¯æ¨¡å‹è¿æ¥

**å®ç°:**
```typescript
const handleFetchModels = async () => {
  setIsFetching(true);
  try {
    const response = await fetch(`/api/models/list?apiType=${formData.apiType}`, {
      headers: { 'X-API-Key': formData.apiKey }
    });
    const data = await response.json();
    setAvailableModels(data.models);
  } catch (error) {
    setFormErrors({ fetch: t('step3.errors.fetchFailed') });
  } finally {
    setIsFetching(false);
  }
};
```

#### Task 4.5-4.6: CLI æ‰©å±•

**å½“å‰:**
```typescript
export const CLI_TYPES = {
  'claude-code': { id: 'claude-code', label: 'Claude Code', description: '...' },
  'gemini-cli': { id: 'gemini-cli', label: 'Gemini CLI', description: '...' },
  'codex': { id: 'codex', label: 'Codex', description: '...' },
};
```

**ç›®æ ‡ (å¯¹é½ BaseCodingAgent æšä¸¾):**
```typescript
import { BaseCodingAgent } from 'shared/types';

export const CLI_TYPES: Record<BaseCodingAgent, CliTypeConfig> = {
  [BaseCodingAgent.CLAUDE_CODE]: { id: 'claude-code', label: 'Claude Code', description: 'Anthropic Claude Code CLI' },
  [BaseCodingAgent.GEMINI]: { id: 'gemini-cli', label: 'Gemini CLI', description: 'Google Gemini CLI' },
  [BaseCodingAgent.CODEX]: { id: 'codex', label: 'Codex', description: 'OpenAI Codex CLI' },
  [BaseCodingAgent.AMP]: { id: 'amp', label: 'Amp', description: 'Sourcegraph Amp CLI' },
  [BaseCodingAgent.CURSOR_AGENT]: { id: 'cursor-agent', label: 'Cursor Agent', description: 'Cursor Agent CLI' },
  [BaseCodingAgent.QWEN_CODE]: { id: 'qwen-code', label: 'Qwen Code', description: 'Alibaba Qwen Code CLI' },
  [BaseCodingAgent.COPILOT]: { id: 'copilot', label: 'Copilot', description: 'GitHub Copilot CLI' },
  [BaseCodingAgent.DROID]: { id: 'droid', label: 'Droid', description: 'Droid CLI' },
  [BaseCodingAgent.OPENCODE]: { id: 'opencode', label: 'Opencode', description: 'Opencode CLI' },
};
```

---

## 3. é£é™©ä¸ç¼“è§£æªæ–½

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| `shared/types.ts` æ˜¯ç”Ÿæˆæ–‡ä»¶ | P0-4 éœ€è¦åç«¯é…åˆ | å…ˆåœ¨å‰ç«¯å®šä¹‰æ‰©å±•ç±»å‹ï¼Œåç»­åŒæ­¥åç«¯ |
| WS åè®®å‡çº§å½±å“ç°æœ‰åŠŸèƒ½ | å¯èƒ½å¯¼è‡´ç»ˆç«¯é€šä¿¡ä¸­æ–­ | ä¿æŒå‘åå…¼å®¹ï¼Œæ–°æ—§åè®®å¹¶å­˜è¿‡æ¸¡ |
| dnd-kit ä¸ç°æœ‰æ ·å¼å†²çª | æ‹–æ‹½è§†è§‰å¼‚å¸¸ | éš”ç¦»æ‹–æ‹½æ ·å¼ï¼Œä½¿ç”¨ CSS å˜é‡ |
| æ¨¡å‹ API æ¶‰åŠå¯†é’¥å®‰å…¨ | å¯†é’¥æ³„éœ²é£é™© | å‰ç«¯ä¸æŒä¹…åŒ–æ˜æ–‡å¯†é’¥ï¼Œä½¿ç”¨åç«¯ä»£ç† |
| ç»ˆç«¯æ•°é‡æ‰©å±•å¢åŠ èµ„æºæ¶ˆè€— | æ€§èƒ½é—®é¢˜ | åç«¯é™æµæ ¡éªŒï¼Œå‰ç«¯æç¤ºèµ„æºå ç”¨ |

---

## 4. éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [x] WebSocket æ¶ˆæ¯åè®®ç¬¦åˆè®¾è®¡ `{type,payload,timestamp,id}`
- [x] 6 ä¸ªæ ¸å¿ƒ Zustand stores æ­£å¸¸å·¥ä½œ
- [x] è°ƒè¯•è§†å›¾å¯è¿›è¡Œ PTY äº¤äº’
- [x] çœ‹æ¿æ”¯æŒæ‹–æ‹½ä»»åŠ¡å¡ç‰‡
- [x] ç»ˆç«¯æ•°é‡æ”¯æŒ 1-10 è‡ªå®šä¹‰
- [x] Step3 å¯çœŸå®è·å–/éªŒè¯æ¨¡å‹
- [x] æ”¯æŒ 9 ä¸ª CLI ç±»å‹

### æµ‹è¯•éªŒæ”¶
- [ ] æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ–°å¢åŠŸèƒ½æœ‰å¯¹åº”å•å…ƒæµ‹è¯•
- [ ] å…³é”®æµç¨‹æœ‰é›†æˆæµ‹è¯•

### ä»£ç è´¨é‡
- [ ] æ—  TypeScript ç±»å‹é”™è¯¯
- [ ] æ—  ESLint è­¦å‘Š
- [ ] ä»£ç å®¡è®¡é€šè¿‡

---

## 5. æ‰§è¡Œæ£€æŸ¥ç‚¹

| æ£€æŸ¥ç‚¹ | å®Œæˆæ ‡å‡† | çŠ¶æ€ |
|--------|----------|------|
| CP1 | é˜¶æ®µ 1 å®Œæˆï¼Œstores å¯ç”¨ | âœ… |
| CP2 | é˜¶æ®µ 2 å®Œæˆï¼Œè°ƒè¯•è§†å›¾å¯äº¤äº’ | âœ… |
| CP3 | é˜¶æ®µ 3 å®Œæˆï¼Œçœ‹æ¿å¯æ‹–æ‹½ | âœ… |
| CP4 | é˜¶æ®µ 4 å®Œæˆï¼Œæµç¨‹æ‰“é€š | âœ… |
| CP5 | é˜¶æ®µ 5 å®Œæˆï¼Œæµç¨‹ä¸€è‡´ | âš ï¸ éƒ¨åˆ† (P1-4 å·²å®Œæˆ) |
| CP6 | é˜¶æ®µ 6 å®Œæˆï¼Œä½“éªŒè¡¥é½ | â¬œ |
| CP7 | å…¨é‡æµ‹è¯•é€šè¿‡ï¼Œåˆå¹¶ä¸»åˆ†æ”¯ | â¬œ |
