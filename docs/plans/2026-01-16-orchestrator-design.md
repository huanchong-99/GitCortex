# 主 Agent 跨终端任务协调核心设计文档

## 概述

本文档描述了 GitCortex（基于 Vibe Kanban）的主 Agent 跨终端任务协调核心的设计方案，实现多 AI 模型的跨终端协同工作流。

## 目录

1. [核心架构](#1-核心架构)
2. [启动机制与 cc-switch 集成](#2-启动机制与-cc-switch-集成)
3. [数据模型](#3-数据模型)
4. [斜杠命令系统](#4-斜杠命令系统)
5. [CLI 检测与验证机制](#5-cli-检测与验证机制)
6. [基于 Git 监测的事件驱动模式](#6-基于-git-监测的事件驱动模式)
7. [前端界面设计](#7-前端界面设计)
8. [看板视图设计](#8-看板视图设计)
9. [流水线视图设计](#9-流水线视图设计)
10. [终端调试视图设计](#10-终端调试视图设计)
11. [分步向导设计](#11-分步向导设计)
12. [状态管理设计](#12-状态管理设计)
13. [WebSocket 通信设计](#13-websocket-通信设计)

---

## 1. 核心架构

### 1.1 新增核心概念

| 概念 | 说明 |
|------|------|
| **Orchestrator** | 主 Agent 协调器，AI 驱动的中央控制器 |
| **Workflow** | 工作流，包含多个并行任务 |
| **Pipeline** | 流水线，定义任务内多个终端的串行执行顺序 |
| **Terminal** | 终端，CLI 实例 + 模型配置的组合 |

### 1.2 多任务并行架构

```
╔═════════════════════════════════════════════════════════════════════════════╗
║                              Orchestrator (主 Agent)                         ║
║              用户配置: API类型 + Base URL + API Key + 模型                   ║
║  ┌─────────────────────────────────────────────────────────────────────┐    ║
║  │                         消息总线 (Message Bus)                       │    ║
║  └─────────────────────────────────────────────────────────────────────┘    ║
║                                                                             ║
║  ┌──────────────────────────────────┐                                       ║
║  │  错误处理终端 (可选)              │                                       ║
║  │  CLI: 用户配置 | Model: 用户配置  │                                       ║
║  └──────────────────────────────────┘                                       ║
╚═══════════════════════════════════════════════════════════════════════════════╝
           │                         │                         │
           ▼                         ▼                         ▼
  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
  │  Task 1         │     │  Task 2         │     │  Task 3         │
  │  branch: login  │     │  branch: i18n   │     │  branch: theme  │
  │                 │     │                 │     │                 │
  │  T1 [串行]      │     │  TA [串行]      │     │  TX [串行]      │
  │  T2             │     │  TB             │     │  TY             │
  │  T3             │     │                 │     │                 │
  └─────────────────┘     └─────────────────┘     └─────────────────┘
           ║                         ║                         ║
           ╚═════════════════════════╩═════════════════════════╝
                            任务间并行执行
                                  │
                                  ▼
  ┌─────────────────────────────────────────────────────────────────────────────┐
  │                        全局合并终端 (Merge Terminal)                         │
  │                    CLI: 用户配置 | Model: 用户配置                           │
  └─────────────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
                              [ main ]
```

### 1.3 关键特性

| 特性 | 说明 |
|------|------|
| **任务间并行** | 多个 Task 同时执行，互不阻塞 |
| **任务内串行** | 每个 Task 内的 Terminal 按顺序执行 |
| **终端数量灵活** | 用户决定每个任务有几个终端 |
| **独立 Git 分支** | 每个 Task 有独立分支 |
| **主 Agent 协调** | 负责启动终端、传递信息、处理审核循环 |

---

## 2. 启动机制与 cc-switch 集成

### 2.1 cc-switch 工作原理

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           cc-switch 原理                                    │
│                                                                             │
│  1. cc-switch 修改系统全局环境变量                                           │
│  2. 终端启动时读取当前环境变量，确定使用的模型                                 │
│  3. 终端启动后，环境变量再修改也不影响已启动的终端                             │
│  4. 因此：所有终端必须在启动阶段串行启动（逐个切换环境变量 → 启动）             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 终端启动流程（串行启动，并行运行）

```
启动阶段 (串行):
═══════════════════════════════════════════════════════════════════════════════

T0: cc-switch → Model-A
    └── 启动 Terminal 1 ✓ 启动完成，等待中

T1: cc-switch → Model-B
    └── 启动 Terminal 2 ✓ 启动完成，等待中

T2: cc-switch → Model-C
    └── 启动 Terminal 3 ✓ 启动完成，等待中

... (所有终端)

═══════════════════════════════════════════════════════════════════════════════
所有终端启动完成，进入就绪状态，等待用户确认开始
═══════════════════════════════════════════════════════════════════════════════
```

### 2.3 终端配置

每个终端是 CLI + 模型的组合，完全由用户在分步向导中配置：

- 支持只使用一种 CLI，也支持使用多种 CLI
- cc-switch 支持在任意 CLI 内切换到任意兼容模型（包括非官方模型如 GLM）
- 同一个 CLI 可以启动多个终端实例，使用不同模型

---

## 3. 数据模型

### 3.1 数据库表结构

```sql
-- 工作流表
CREATE TABLE workflow (
    id                      UUID PRIMARY KEY,
    name                    TEXT NOT NULL,
    status                  TEXT NOT NULL DEFAULT 'created',
    -- created, starting, ready, running, merging, completed, failed

    use_slash_commands      BOOLEAN DEFAULT FALSE,

    -- 主 Agent 配置
    orchestrator_api_type   TEXT,
    orchestrator_base_url   TEXT,
    orchestrator_api_key    TEXT,
    orchestrator_model      TEXT,

    -- 错误处理终端配置 (可选)
    error_terminal_enabled  BOOLEAN DEFAULT FALSE,
    error_terminal_cli      TEXT,
    error_terminal_model    TEXT,

    -- 合并终端配置
    merge_terminal_cli      TEXT NOT NULL,
    merge_terminal_model    TEXT NOT NULL,

    ready_at                DATETIME,
    created_at              DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at              DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 斜杠命令预设表 (全局，长期存储)
CREATE TABLE slash_command_preset (
    id              UUID PRIMARY KEY,
    command         TEXT NOT NULL UNIQUE,
    description     TEXT NOT NULL,
    is_system       BOOLEAN DEFAULT FALSE,
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 工作流使用的斜杠命令
CREATE TABLE workflow_command (
    id              UUID PRIMARY KEY,
    workflow_id     UUID REFERENCES workflow(id),
    preset_id       UUID REFERENCES slash_command_preset(id),
    order_index     INTEGER NOT NULL,
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 任务表
CREATE TABLE workflow_task (
    id              UUID PRIMARY KEY,
    workflow_id     UUID REFERENCES workflow(id),
    task_id         UUID REFERENCES task(id),
    name            TEXT NOT NULL,
    branch          TEXT NOT NULL,
    status          TEXT NOT NULL DEFAULT 'pending',
    order_index     INTEGER NOT NULL,
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 终端表
CREATE TABLE terminal (
    id              UUID PRIMARY KEY,
    workflow_task_id UUID REFERENCES workflow_task(id),
    cli             TEXT NOT NULL,
    model           TEXT NOT NULL,
    role            TEXT,
    order_index     INTEGER NOT NULL,
    status          TEXT NOT NULL DEFAULT 'not_started',
    -- not_started, waiting, working, completed, failed
    process_id      INTEGER,
    session_id      TEXT,
    started_at      DATETIME,
    completed_at    DATETIME,
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- CLI 类型表
CREATE TABLE cli_type (
    id                  UUID PRIMARY KEY,
    name                TEXT NOT NULL UNIQUE,
    display_name        TEXT NOT NULL,
    detect_command      TEXT NOT NULL,
    install_command     TEXT,
    install_guide_url   TEXT,
    is_system           BOOLEAN DEFAULT TRUE,
    created_at          DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 模型配置表
CREATE TABLE model_config (
    id              UUID PRIMARY KEY,
    cli_type_id     UUID REFERENCES cli_type(id),
    name            TEXT NOT NULL,
    display_name    TEXT NOT NULL,
    cc_switch_cmd   TEXT,
    is_official     BOOLEAN DEFAULT FALSE,
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP,

    UNIQUE(cli_type_id, name)
);
```

### 3.2 工作流生命周期

```
创建 ──→ 启动中 ──→ 就绪 ──→ 运行中 ──→ 合并中 ──→ 已完成
(created) (starting) (ready) (running) (merging) (completed)
                       │
                       │ 所有终端已启动
                       │ 等待用户确认开始
                       │ 用户可进入终端调试视图
```

---

## 4. 斜杠命令系统

### 4.1 使用方式

斜杠命令系统是**可选的**。用户可以：
- 配置斜杠命令：主 Agent 按命令顺序执行
- 不配置：主 Agent 自行决策

### 4.2 主 Agent 任务发布格式

```
/斜杠命令 具体要求

示例:
/write-code 实现用户登录页面，包含用户名密码输入框和登录按钮
/review 检查代码安全性，特别关注XSS和SQL注入风险
/fix-issues 修复审计发现的3个中等风险问题
```

### 4.3 预设系统

- 系统内置预设：/write-code, /review, /fix-issues, /test, /refactor, /document
- 用户自定义预设：可长期存储，跨工作流复用
- 在设置页面管理预设

---

## 5. CLI 检测与验证机制

### 5.1 程序启动时检测

- 检测方式：执行 `CLI --version` 或 `which/where` 命令
- 显示已安装和未安装的 CLI 列表
- 提供安装指南链接

### 5.2 分步向导中的验证

- CLI 选项必须齐全（显示所有支持的 CLI）
- 用户可以选择任何 CLI
- 如果选择了未安装的 CLI，显示警告并禁止进入下一步
- 提供安装命令和重新检测按钮

---

## 6. 基于 Git 监测的事件驱动模式

### 6.1 核心原则

```
✗ 错误方式 (轮询):
  主 Agent 每隔 N 秒检查终端状态 → 大量 token 消耗

✓ 正确方式 (事件驱动):
  Git 监测服务检测到提交 → 唤醒主 Agent → 主 Agent 处理

强制规则:
  每个终端完成任务后必须提交 Git，这是唯一的"完成信号"
```

### 6.2 Git 监测服务

- 监听方式：文件系统监听 (.git/refs/heads/) 或定期轻量检查
- 检测到提交后：解析提交信息 → 识别来源终端 → 生成事件 → 唤醒主 Agent
- 低资源消耗，无 AI 调用

### 6.3 强制 Git 提交规范

```
[Terminal:{terminal_id}] [Status:{status}] {summary}

{详细描述}

---METADATA---
workflow_id: {workflow_id}
task_id: {task_id}
terminal_order: {order}
cli: {cli_type}
model: {model}
status: {completed|review_pass|review_reject|failed}
severity: {minor|major} (如果是审核打回)
reviewed_terminal: {terminal_id} (如果是审核)
issues: [{...}] (如果是审核打回)
next_action: {continue|retry|merge}
```

### 6.4 主 Agent 事件处理

```
主 Agent 状态:
┌──────────┐     Git事件      ┌──────────┐    处理完成    ┌──────────┐
│  休眠中   │ ───────────────→ │  处理中   │ ─────────────→ │  休眠中   │
│ (无消耗)  │                  │ (消耗token)│               │ (无消耗)  │
└──────────┘                  └──────────┘               └──────────┘
```

### 6.5 Token 消耗对比

| 模式 | 消耗 |
|------|------|
| 轮询模式 | ~1,080,000 token/小时 |
| 事件驱动 | ~18,000 token/工作流 |
| **节省** | **98%+** |

---

## 7. 前端界面设计

### 7.1 技术栈

| 技术 | 用途 |
|------|------|
| **React 18** | 前端框架 |
| **TypeScript** | 类型安全 |
| **Tailwind CSS** | 样式系统 |
| **Radix UI** | 无头组件库 (shadcn/ui 风格) |
| **Zustand** | 状态管理 |
| **React Query** | 数据获取 |
| **xterm.js** | 终端渲染 |
| **WebSocket** | 实时通信 |

### 7.2 页面路由结构

```
GitCortex 前端路由
├── /                           # 首页（重定向到看板）
├── /board                      # 看板视图（任务卡片拖拽）
├── /pipeline/:workflowId       # 流水线视图（终端执行流程）
├── /debug/:workflowId          # 终端调试视图（原生终端交互）
├── /wizard                     # 工作流创建向导
│   ├── /wizard/project         # 步骤0: 工作目录
│   ├── /wizard/basic           # 步骤1: 基础配置
│   ├── /wizard/tasks           # 步骤2: 任务配置
│   ├── /wizard/models          # 步骤3: 模型配置
│   ├── /wizard/terminals       # 步骤4: 终端配置
│   ├── /wizard/commands        # 步骤5: 斜杠命令
│   └── /wizard/advanced        # 步骤6: 高级配置
└── /settings                   # 设置页面
    ├── /settings/cli           # CLI 管理
    ├── /settings/models        # 模型配置
    └── /settings/presets       # 斜杠命令预设管理
```

### 7.3 组件层次架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              App (根组件)                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                        Layout (布局组件)                             │   │
│  │  ┌──────────────┐  ┌──────────────────────────────────────────────┐ │   │
│  │  │   Sidebar    │  │              Main Content                    │ │   │
│  │  │  ┌────────┐  │  │  ┌────────────────────────────────────────┐  │ │   │
│  │  │  │ Nav    │  │  │  │            Router Outlet               │  │ │   │
│  │  │  │ Items  │  │  │  │  ┌──────────────────────────────────┐  │  │ │   │
│  │  │  ├────────┤  │  │  │  │           Pages                  │  │  │ │   │
│  │  │  │ View   │  │  │  │  │  • BoardView                     │  │  │ │   │
│  │  │  │ Switch │  │  │  │  │  • PipelineView                  │  │  │ │   │
│  │  │  ├────────┤  │  │  │  │  • DebugTerminalView             │  │  │ │   │
│  │  │  │Workflow│  │  │  │  │  • WizardView                    │  │  │ │   │
│  │  │  │ List   │  │  │  │  │  • SettingsView                  │  │  │ │   │
│  │  │  └────────┘  │  │  │  └──────────────────────────────────┘  │  │ │   │
│  │  └──────────────┘  │  └────────────────────────────────────────┘  │ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Global Providers                               │   │
│  │    • QueryClientProvider (React Query)                              │   │
│  │    • WebSocketProvider (实时通信)                                    │   │
│  │    • ToastProvider (通知)                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.4 三视图模式

| 视图 | 用途 |
|------|------|
| **看板视图** | 任务状态总览，类似原 Vibe Kanban |
| **流水线视图** | 终端执行流程，类似 CI/CD 流水线 |
| **终端调试视图** | 直接访问原生终端，验证配置 |

---

## 8. 看板视图设计

### 8.1 界面布局

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│ GitCortex                                          [看板] [流水线] [调试]    ⚙️ 设置    │
├──────────┬──────────────────────────────────────────────────────────────────────────────┤
│          │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  工作流   │  │  待启动     │  │   就绪      │  │   运行中    │  │   已完成    │         │
│  列表     │  │  created    │  │   ready     │  │   running   │  │  completed  │         │
│          │  ├─────────────┤  ├─────────────┤  ├─────────────┤  ├─────────────┤         │
│  ┌─────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │         │
│  │WF-1 │ │  │ │ Task-1  │ │  │ │ Task-2  │ │  │ │ Task-3  │ │  │ │ Task-4  │ │         │
│  │     │ │  │ │ login   │ │  │ │ i18n    │ │  │ │ theme   │ │  │ │ auth    │ │         │
│  ├─────┤ │  │ │ 3终端   │ │  │ │ 2终端   │ │  │ │ 2终端   │ │  │ │ 3终端   │ │         │
│  │WF-2 │ │  │ │ T1▪T2▪T3│ │  │ │ TA▪TB   │ │  │ │ TX●TY   │ │  │ │ ✓ 完成  │ │         │
│  │ ●   │ │  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │         │
│  └─────┘ │  │             │  │             │  │             │  │             │         │
│          │  │             │  │             │  │             │  │             │         │
│  + 新建  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘         │
├──────────┴──────────────────────────────────────────────────────────────────────────────┤
│                           终端实时活动面板 (可折叠/展开)                                │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────┐ ┌────────────────────────────┐ ┌──────────────────────┐│
│  │ TX (Claude Opus)           │ │ TY (Gemini Pro)            │ │ TB (Qwen Code)       ││
│  │ Task: theme                │ │ Task: theme                │ │ Task: i18n           ││
│  │ Status: ● Working          │ │ Status: ○ Waiting          │ │ Status: ● Working    ││
│  ├────────────────────────────┤ ├────────────────────────────┤ ├──────────────────────┤│
│  │ > 正在创建暗色主题变量...  │ │ > 等待 TX 完成...          │ │ > 翻译中文资源文件... ││
│  │ > 修改 colors.css          │ │                            │ │ > zh-CN.json: 45%    ││
│  │ > 添加 ThemeProvider       │ │                            │ │ > 已处理 120/267 条  ││
│  │ [最后更新: 3秒前]          │ │ [等待中]                   │ │ [最后更新: 1秒前]    ││
│  └────────────────────────────┘ └────────────────────────────┘ └──────────────────────┘│
├─────────────────────────────────────────────────────────────────────────────────────────┤
│  主Agent: 休眠中 | 活跃终端: 2/5 | Token消耗: 12,450 | Git提交: 监听中                  │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 组件结构

```
BoardView/
├── WorkflowSidebar          # 工作流列表侧边栏
├── KanbanBoard              # 看板主体
│   ├── KanbanColumn         # 状态列 (可拖拽目标)
│   └── TaskCard             # 任务卡片 (可拖拽)
│       ├── TaskHeader       # 任务名称、分支
│       └── TerminalDots     # 终端状态指示器
├── TerminalActivityPanel    # 终端实时活动面板
│   └── TerminalActivityCard # 单个终端活动卡片
│       ├── TerminalHeader   # 终端名称、模型、状态
│       └── TerminalOutput   # 实时输出内容（最近3-5行）
└── StatusBar                # 底部状态栏
```

### 8.3 终端活动面板特性

- 只显示当前活跃 (Working/Waiting) 的终端
- 每个卡片显示最近 3-5 行输出
- 点击卡片可跳转到该终端的详细视图
- 面板可折叠以节省空间

---

## 9. 流水线视图设计

### 9.1 界面布局

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│ GitCortex > Workflow-1                         [看板] [流水线] [调试]    ⚙️ 设置          │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Orchestrator (主Agent - Claude Opus)                   │ │
│  │                    Status: 休眠中 ● | 等待 Git 事件 | Token: 8,200                  │ │
│  └─────────────────────────────────────────────────────────────────────────────────────┘ │
│                     │                    │                    │                          │
│                     ▼                    ▼                    ▼                          │
│  ┌────────────────────────┐ ┌────────────────────────┐ ┌────────────────────────┐       │
│  │    Task: login         │ │    Task: i18n          │ │    Task: theme         │       │
│  │    branch: feat/login  │ │    branch: feat/i18n   │ │    branch: feat/theme  │       │
│  │    ──────────────────  │ │    ──────────────────  │ │    ──────────────────  │       │
│  │                        │ │                        │ │                        │       │
│  │  ┌──────────────────┐  │ │  ┌──────────────────┐  │ │  ┌──────────────────┐  │       │
│  │  │ T1: Claude Sonnet│  │ │  │ TA: Gemini Pro   │  │ │  │ TX: Claude Opus  │  │       │
│  │  │ /write-code      │  │ │  │ /write-code      │  │ │  │ /write-code      │  │       │
│  │  │ ✓ 已完成         │  │ │  │ ✓ 已完成         │  │ │  │ ● 工作中         │  │       │
│  │  └────────┬─────────┘  │ │  └────────┬─────────┘  │ │  └────────┬─────────┘  │       │
│  │           │            │ │           │            │ │           │            │       │
│  │           ▼            │ │           ▼            │ │           │ (等待)     │       │
│  │  ┌──────────────────┐  │ │  ┌──────────────────┐  │ │  ┌──────────────────┐  │       │
│  │  │ T2: GPT-4o       │  │ │  │ TB: Qwen Code    │  │ │  │ TY: Gemini Pro   │  │       │
│  │  │ /review          │  │ │  │ /review          │  │ │  │ /review          │  │       │
│  │  │ ● 工作中         │  │ │  │ ○ 等待中         │  │ │  │ ○ 等待中         │  │       │
│  │  └────────┬─────────┘  │ │  └────────┬─────────┘  │ │  └────────┬─────────┘  │       │
│  │           │            │ │           │            │ │           │            │       │
│  │           ▼            │ │           ▼            │ │           ▼            │       │
│  │  ┌──────────────────┐  │ │                        │ │                        │       │
│  │  │ T3: Claude Haiku │  │ │                        │ │                        │       │
│  │  │ /fix-issues      │  │ │                        │ │                        │       │
│  │  │ ○ 等待中         │  │ │                        │ │                        │       │
│  │  └──────────────────┘  │ │                        │ │                        │       │
│  └────────────────────────┘ └────────────────────────┘ └────────────────────────┘       │
│                     │                    │                    │                          │
│                     └────────────────────┼────────────────────┘                          │
│                                          ▼                                               │
│                          ┌────────────────────────────────┐                              │
│                          │     Merge Terminal            │                              │
│                          │     Claude Opus + Git MCP      │                              │
│                          │     Status: ○ 等待所有任务完成  │                              │
│                          └────────────────────────────────┘                              │
│                                          │                                               │
│                                          ▼                                               │
│                                      [ main ]                                            │
│                                                                                           │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│  点击任意终端节点可展开详细输出面板                                                        │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 组件结构

```
PipelineView/
├── OrchestratorHeader       # 主Agent状态头部
├── TaskPipelineGrid         # 任务流水线网格
│   └── TaskPipeline         # 单个任务流水线
│       ├── TaskHeader       # 任务名称、分支
│       └── TerminalNode     # 终端节点
│           ├── NodeIcon     # 状态图标 (✓●○)
│           ├── NodeInfo     # 模型、命令
│           └── NodeConnector# 连接线
├── MergeTerminalNode        # 合并终端节点
└── TerminalDetailPanel      # 终端详情面板 (点击展开)
```

---

## 10. 终端调试视图设计

### 10.1 设计目的

在所有终端启动完成后（就绪状态），用户可以进入终端调试视图：
- 验证环境配置是否正确
- 安装缺失的插件或斜杠命令
- 测试命令是否可用
- 确认就绪后点击"开始任务"

### 10.2 界面布局

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│ GitCortex > Workflow-1 > 终端调试                [看板] [流水线] [调试]    ⚙️ 设置        │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│  工作流状态: 就绪 (Ready)                                       [直接开始] [开始任务 ▶]  │
├────────────┬──────────────────────────────────────────────────────────────────────────────┤
│            │  ┌──────────────────────────────────────────────────────────────────────┐   │
│  终端列表   │  │                    原生 PTY 终端 (xterm.js + node-pty)               │   │
│            │  │                                                                      │   │
│  Task:login│  │  ┌────────────────────────────────────────────────────────────────┐  │   │
│  ┌───────┐ │  │  │  ~/projects/my-app                                             │  │   │
│  │ T1 ●  │←│  │  │  $ claude                                                      │  │   │
│  │ T2 ○  │ │  │  │                                                                │  │   │
│  │ T3 ○  │ │  │  │  ╭──────────────────────────────────────────────────────────╮  │  │   │
│  └───────┘ │  │  │  │  Claude Code v1.0.28                                     │  │  │   │
│            │  │  │  │  Model: claude-sonnet-4-20250514                         │  │  │   │
│  Task:i18n │  │  │  ╰──────────────────────────────────────────────────────────╯  │  │   │
│  ┌───────┐ │  │  │                                                                │  │   │
│  │ TA ○  │ │  │  │  > /wr█                                                        │  │   │
│  │ TB ○  │ │  │  │     ┌─────────────────────────────────────┐                    │  │   │
│  └───────┘ │  │  │     │ /write-code    编写功能代码        │ ← CLI 原生自动补全  │  │   │
│            │  │  │     │ /wrap          换行模式            │                    │  │   │
│  Task:theme│  │  │     └─────────────────────────────────────┘                    │  │   │
│  ┌───────┐ │  │  │                                                                │  │   │
│  │ TX ○  │ │  │  │  (Tab 补全 • 上下箭头历史 • Ctrl+C 中断 - CLI 原生行为)         │  │   │
│  │ TY ○  │ │  │  └────────────────────────────────────────────────────────────────┘  │   │
│  └───────┘ │  └──────────────────────────────────────────────────────────────────────┘   │
│            │                                                                              │
│  ────────  │  注意: 无独立输入框。所有输入直接在 PTY 终端内进行，保持 CLI 原生体验。        │
│  Merge     │                                                                              │
│  ┌───────┐ │                                                                              │
│  │ M  ○  │ │                                                                              │
│  └───────┘ │                                                                              │
├────────────┴──────────────────────────────────────────────────────────────────────────────┤
│  主Agent: 休眠中 | 当前终端: T1 | CLI: Claude Code | Model: Sonnet | PTY: Active          │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.3 技术实现架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  前端 (浏览器)                      │       后端 (Node.js/Rust)                          │
│                                    │                                                    │
│  ┌────────────────┐                │       ┌────────────────────────────┐              │
│  │   xterm.js     │ ←── WebSocket ───→    │   node-pty / PTY 进程       │              │
│  │  (终端渲染器)   │      (双向)    │       │   (真正的伪终端)            │              │
│  └────────────────┘                │       └──────────┬─────────────────┘              │
│                                    │                  │                                │
│  用户输入 → WebSocket 发送          │       PTY 进程 fork → CLI 子进程                  │
│  终端输出 ← WebSocket 接收          │       CLI 的 stdin/stdout 直连 PTY               │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 10.4 关键特性

| 特性 | 说明 |
|------|------|
| **CLI 原生自动补全** | Tab 补全、斜杠命令提示 |
| **CLI 原生语法高亮** | 命令颜色、参数颜色 |
| **CLI 原生快捷键** | Ctrl+C, Ctrl+D, 上下箭头 |
| **CLI 原生 ANSI 颜色** | 完整的终端颜色支持 |
| **主 Agent 休眠** | 调试阶段零 token 消耗 |

### 10.5 组件结构

```
DebugTerminalView/
├── WorkflowStatusBar        # 工作流状态和操作按钮
├── TerminalSidebar          # 终端列表侧边栏
│   ├── TaskGroup            # 按任务分组
│   └── TerminalItem         # 终端项 (点击切换)
├── TerminalContainer        # 终端主容器
│   ├── TerminalHeader       # 终端信息头
│   └── XTermContainer       # xterm.js 终端渲染 (无独立输入框)
└── StatusBar                # 底部状态栏
```

### 10.6 工作流程

```
所有终端启动完成
        │
        ▼
   ┌──────────┐
   │ 就绪状态  │
   └────┬─────┘
        │
   ┌────┴────┐
   ▼         ▼
直接开始   进入终端调试
   │         │
   │         ▼
   │    用户在终端中:
   │    • 验证环境
   │    • 安装插件
   │    • 测试命令
   │         │
   │         │ 确认就绪
   │         ▼
   │    点击"开始任务"
   │         │
   └────┬────┘
        │
        ▼
   ┌──────────┐
   │ 运行状态  │
   │ 主Agent  │
   │ 开始协调  │
   └──────────┘
```

---

## 11. 分步向导设计

### 11.1 步骤流程总览

```
步骤0: 工作目录     → 选择项目文件夹，检测/初始化 Git
步骤1: 基础配置     → 工作流名称、任务数量
步骤2: 任务配置     → 每个任务的名称、描述、终端数量
步骤3: 模型配置     → 配置 API Key、Base URL、获取可用模型
步骤4: 终端配置     → 为每个任务的终端选择 CLI 和模型
步骤5: 斜杠命令     → 可选，配置执行命令顺序
步骤6: 高级配置     → 主 Agent、错误处理终端、合并终端、Git 规范
```

### 11.2 步骤 0 - 工作目录选择

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│                              创建新工作流                                    [✕ 取消]    │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                           │
│   ● 步骤0         ○ 步骤1         ○ 步骤2         ○ 步骤3         ○ 步骤4         ○ ...  │
│   工作目录        基础配置        任务配置        模型配置        终端配置               │
│                                                                                           │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                           │
│   选择项目工作目录                                                                        │
│                                                                                           │
│   ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│   │  📁 选择文件夹                                                                    │  │
│   │                                                                                   │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐ │  │
│   │  │ F:\Projects\my-app                                            [浏览...]     │ │  │
│   │  └─────────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                   │  │
│   │  或拖拽文件夹到此处                                                               │  │
│   └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                           │
│   ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│   │  Git 状态检测                                                                     │  │
│   │                                                                                   │  │
│   │  ✓ 检测到 Git 仓库                                                               │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐ │  │
│   │  │  当前分支: main                                                             │ │  │
│   │  │  远程仓库: https://github.com/user/my-app.git                               │ │  │
│   │  │  工作区状态: 干净 (无未提交更改)                                             │ │  │
│   │  └─────────────────────────────────────────────────────────────────────────────┘ │  │
│   └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                           │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                          [下一步 →]      │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

**未检测到 Git 时的处理：**

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│  Git 状态检测                                                                             │
│                                                                                           │
│  ⚠️ 未检测到 Git 仓库                                                                     │
│                                                                                           │
│  此文件夹不是 Git 仓库。GitCortex 需要 Git 来协调多终端工作流。                            │
│                                                                                           │
│  是否初始化 Git 仓库？                                                                    │
│                                                                                           │
│  [初始化 Git 仓库]     [选择其他文件夹]                                                   │
│                                                                                           │
│  初始化将执行:                                                                            │
│  • git init                                                                              │
│  • 创建 .gitignore (基于项目类型)                                                        │
│  • git add . && git commit -m "Initial commit"                                           │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.3 步骤 1 - 基础配置

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│   工作流名称                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │ 用户系统重构                                                                    │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   本次启动几个并行任务？                                                                  │
│   ┌────────────────────────────────────────────────────────────────────────────────┐     │
│   │  ○ 1个任务    ○ 2个任务    ● 3个任务    ○ 4个任务    ○ 更多 [___]            │     │
│   └────────────────────────────────────────────────────────────────────────────────┘     │
│                                                                                           │
│   是否从看板导入已有任务？                                                                │
│   ┌────────────────────────────────────────────────────────────────────────────────┐     │
│   │  ○ 新建任务 (下一步手动配置)                                                   │     │
│   │  ○ 从看板导入 (选择已有任务卡片)                                               │     │
│   └────────────────────────────────────────────────────────────────────────────────┘     │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.4 步骤 2 - 任务详细配置

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│   配置 3 个并行任务                                               任务 1/3   [<] [>]    │
│                                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │  任务 1                                                                         │    │
│   │                                                                                 │    │
│   │  任务名称 *                                                                     │    │
│   │  ┌───────────────────────────────────────────────────────────────────────────┐ │    │
│   │  │ 登录功能                                                                  │ │    │
│   │  └───────────────────────────────────────────────────────────────────────────┘ │    │
│   │                                                                                 │    │
│   │  Git 分支名称                                                                   │    │
│   │  ┌───────────────────────────────────────────────────────────────────────────┐ │    │
│   │  │ feat/login                                          (自动生成，可修改)    │ │    │
│   │  └───────────────────────────────────────────────────────────────────────────┘ │    │
│   │                                                                                 │    │
│   │  任务描述 (AI 将根据此描述执行任务) *                                           │    │
│   │  ┌───────────────────────────────────────────────────────────────────────────┐ │    │
│   │  │ 实现用户登录功能:                                                         │ │    │
│   │  │ 1. 创建登录页面组件，包含用户名和密码输入框                                │ │    │
│   │  │ 2. 实现表单验证（用户名非空、密码至少6位）                                 │ │    │
│   │  │ 3. 对接 /api/auth/login 接口                                              │ │    │
│   │  │ 4. 登录成功后跳转到首页，保存 token 到 localStorage                        │ │    │
│   │  │ 5. 处理登录失败的错误提示                                                 │ │    │
│   │  │                                                           (支持 Markdown) │ │    │
│   │  └───────────────────────────────────────────────────────────────────────────┘ │    │
│   │                                                                                 │    │
│   │  此任务需要几个终端串行执行？                                                   │    │
│   │  ┌────────────────────────────────────────────────────────────────────────────┐│    │
│   │  │  ○ 1个    ● 2个    ○ 3个    ○ 更多 [___]                                  ││    │
│   │  └────────────────────────────────────────────────────────────────────────────┘│    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   任务进度: [====○---------]  1 / 3 已配置                                               │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.5 步骤 3 - 模型配置

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│   配置可用模型 (cc-switch)                                                               │
│   这些模型将在终端配置中供选择                                                            │
│                                                                                           │
│   ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│   │  已配置的模型                                                        [+ 添加模型] │  │
│   │                                                                                   │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐ │  │
│   │  │  Claude Sonnet                                               [编辑] [删除] │ │  │
│   │  │  API: Anthropic | 模型: claude-sonnet-4-20250514                            │ │  │
│   │  │  状态: ✓ 已验证                                                             │ │  │
│   │  └─────────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                   │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐ │  │
│   │  │  Gemini Pro                                                  [编辑] [删除] │ │  │
│   │  │  API: Google | 模型: gemini-2.0-flash                                       │ │  │
│   │  │  状态: ✓ 已验证                                                             │ │  │
│   │  └─────────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                                                                   │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐ │  │
│   │  │  GLM-4 Plus                                                  [编辑] [删除] │ │  │
│   │  │  API: OpenAI兼容 | Base: https://open.bigmodel.cn/api/paas/v4              │ │  │
│   │  │  模型: glm-4-plus | 状态: ✓ 已验证                                          │ │  │
│   │  └─────────────────────────────────────────────────────────────────────────────┘ │  │
│   └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                           │
│   提示: 至少需要配置一个模型才能继续                                                      │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

**添加模型弹窗（带获取可用模型功能）：**

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│                              添加模型                                        [✕ 关闭]    │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                           │
│   模型名称 (自定义显示名)                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │ Claude Sonnet                                                                   │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   API 类型                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │ ● Anthropic (官方)    ○ Google (Gemini)    ○ OpenAI    ○ OpenAI 兼容          │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   Base URL                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │ https://api.anthropic.com                          (官方自动填充，兼容需手动)   │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   API Key                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │ sk-ant-api03-xxxxxxxxxxxxxxxxxxxxx                                   [👁 显示]  │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │                           [🔄 获取可用模型]                                     │    │
│   │  获取状态: ✓ 成功获取 12 个可用模型                                             │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   模型选择                                                                                │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │ claude-sonnet-4-20250514                                                   ▼    │    │
│   │ ┌─────────────────────────────────────────────────────────────────────────────┐│    │
│   │ │ claude-opus-4-20250514          (最强，高成本)                              ││    │
│   │ │ claude-sonnet-4-20250514        (平衡，推荐)                        ← 当前  ││    │
│   │ │ claude-haiku-3-5-20241022       (快速，低成本)                              ││    │
│   │ └─────────────────────────────────────────────────────────────────────────────┘│    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │  [验证连接]     验证状态: ✓ 连接成功，模型可用                                  │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│                                                               [取消]      [保存模型]     │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.6 步骤 4 - 终端配置

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│   配置终端 - 任务: 登录功能                                          任务 1/3   [<] [>] │
│   此任务有 2 个串行终端                                                                  │
│                                                                                           │
│   ┌───────────────────────────────────────────────────────────────────────────────────┐  │
│   │  终端 1 (第一个执行)                                                              │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐ │  │
│   │  │  CLI 选择                                                                   │ │  │
│   │  │  ┌─────────────────────────────────────────────────────────────────────────┐│ │  │
│   │  │  │ ● Claude Code    ✓ 已安装                                              ││ │  │
│   │  │  │ ○ Gemini CLI     ✓ 已安装                                              ││ │  │
│   │  │  │ ○ Codex          ✓ 已安装                                              ││ │  │
│   │  │  │ ○ Cursor Agent   ✗ 未安装  [安装指南]                                   ││ │  │
│   │  │  └─────────────────────────────────────────────────────────────────────────┘│ │  │
│   │  │                                                                             │ │  │
│   │  │  模型选择 (从步骤3配置的模型中选择)                                          │ │  │
│   │  │  ┌─────────────────────────────────────────────────────────────────────────┐│ │  │
│   │  │  │ Claude Sonnet                                                      ▼   ││ │  │
│   │  │  └─────────────────────────────────────────────────────────────────────────┘│ │  │
│   │  │                                                                             │ │  │
│   │  │  角色描述 (可选)                                                            │ │  │
│   │  │  ┌─────────────────────────────────────────────────────────────────────────┐│ │  │
│   │  │  │ 代码编写者                                                             ││ │  │
│   │  │  └─────────────────────────────────────────────────────────────────────────┘│ │  │
│   │  └─────────────────────────────────────────────────────────────────────────────┘ │  │
│   │                                          │                                        │  │
│   │                                          ▼                                        │  │
│   │  终端 2 (等待终端1完成后执行)                                                     │  │
│   │  ┌─────────────────────────────────────────────────────────────────────────────┐ │  │
│   │  │  CLI: [Gemini CLI ▼]    模型: [Gemini Pro ▼]    角色: [代码审核者]          │ │  │
│   │  └─────────────────────────────────────────────────────────────────────────────┘ │  │
│   └───────────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                           │
│   ⚠️ 提示: 选择了未安装的 CLI 将无法进入下一步                                           │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.7 步骤 5 - 斜杠命令配置

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│   是否配置斜杠命令？                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │ ○ 不配置 - 主 Agent 自行决策任务执行方式                                        │    │
│   │ ● 配置斜杠命令 - 主 Agent 按命令顺序分发任务                                    │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   选择本工作流使用的斜杠命令 (按执行顺序排列)                                             │
│                                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │  已选命令 (拖拽排序)                                           清空 | 重置默认  │    │
│   │  ┌───────────────────────────────────────────────────────────────────────────┐ │    │
│   │  │ ≡ 1. /write-code    编写功能代码                                   [✕]   │ │    │
│   │  │ ≡ 2. /review        代码审计，检查安全性和代码质量                 [✕]   │ │    │
│   │  │ ≡ 3. /fix-issues    修复发现的问题                                 [✕]   │ │    │
│   │  └───────────────────────────────────────────────────────────────────────────┘ │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │  可用命令预设                                                                   │    │
│   │                                                                                 │    │
│   │  系统内置:                                                                      │    │
│   │  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐   │    │
│   │  │/write-code │ │  /review   │ │/fix-issues │ │   /test    │ │ /refactor  │   │    │
│   │  │    [+]     │ │    [+]     │ │    [+]     │ │    [+]     │ │    [+]     │   │    │
│   │  └────────────┘ └────────────┘ └────────────┘ └────────────┘ └────────────┘   │    │
│   │                                                                                 │    │
│   │  用户自定义:                                                   [+ 新建命令]    │    │
│   │  ┌────────────┐ ┌──────────────┐                                              │    │
│   │  │ /optimize  │ │/security-scan│                                              │    │
│   │  │    [+]     │ │     [+]      │                                              │    │
│   │  └────────────┘ └──────────────┘                                              │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.8 步骤 6 - 高级配置

```
┌───────────────────────────────────────────────────────────────────────────────────────────┐
│   主 Agent (Orchestrator) 配置                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │  选择模型 (从步骤3已配置的模型中选择)                                            │    │
│   │  ┌─────────────────────────────────────────────────────────────────────────┐   │    │
│   │  │ Claude Opus                                                        ▼   │   │    │
│   │  └─────────────────────────────────────────────────────────────────────────┘   │    │
│   │  推荐: 使用能力最强的模型作为主 Agent                                            │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   错误处理终端 (可选)                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │  ☐ 启用错误处理终端                                                             │    │
│   │  CLI:    [Claude Code      ▼]    模型:   [Claude Opus      ▼]                   │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   合并终端配置                                                                            │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │  CLI:    [Claude Code      ▼]    模型:   [Claude Sonnet    ▼]                   │    │
│   │  ☑ 合并前运行测试    ☑ 合并冲突时暂停等待人工处理                               │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
│   📋 Git 提交规范 (系统强制，不可修改)                                   [查看详情 ▼]   │
│   ┌─────────────────────────────────────────────────────────────────────────────────┐    │
│   │  系统要求每个终端完成任务后必须按以下格式提交 Git:                                │    │
│   │  ┌─────────────────────────────────────────────────────────────────────────┐   │    │
│   │  │ [Terminal:{terminal_id}] [Status:{status}] {简要摘要}                   │   │    │
│   │  │                                                                         │   │    │
│   │  │ ## 变更内容                                                             │   │    │
│   │  │ - 详细描述本次提交的所有变更                                            │   │    │
│   │  │ - 每个文件的修改目的                                                    │   │    │
│   │  │ - 新增/修改/删除了哪些功能                                              │   │    │
│   │  │                                                                         │   │    │
│   │  │ ## 技术细节                                                             │   │    │
│   │  │ - 使用的技术方案                                                        │   │    │
│   │  │ - 关键代码逻辑说明                                                      │   │    │
│   │  │ - 依赖变更说明（如有）                                                  │   │    │
│   │  │                                                                         │   │    │
│   │  │ ## 测试情况                                                             │   │    │
│   │  │ - 已执行的测试                                                          │   │    │
│   │  │ - 测试结果                                                              │   │    │
│   │  │                                                                         │   │    │
│   │  │ ---METADATA---                                                          │   │    │
│   │  │ workflow_id: {workflow_id}                                              │   │    │
│   │  │ task_id: {task_id}                                                      │   │    │
│   │  │ terminal_id: {terminal_id}                                              │   │    │
│   │  │ terminal_order: {order}                                                 │   │    │
│   │  │ cli: {cli_type}                                                         │   │    │
│   │  │ model: {model}                                                          │   │    │
│   │  │ status: {completed|review_pass|review_reject|failed}                    │   │    │
│   │  │ files_changed: [{file_path, change_type, lines_added, lines_deleted}]   │   │    │
│   │  │ execution_time_seconds: {seconds}                                       │   │    │
│   │  │ token_usage: {input_tokens, output_tokens}                              │   │    │
│   │  │ severity: {minor|major|critical} (如果是审核打回)                       │   │    │
│   │  │ reviewed_terminal: {terminal_id} (如果是审核任务)                       │   │    │
│   │  │ issues: [{type, severity, description, file, line}] (如果发现问题)      │   │    │
│   │  │ next_action: {continue|retry|merge|escalate}                            │   │    │
│   │  └─────────────────────────────────────────────────────────────────────────┘   │    │
│   │                                                                                 │    │
│   │  此规范确保 Git 监测服务能准确识别终端状态和任务进度                             │    │
│   └─────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                           │
├───────────────────────────────────────────────────────────────────────────────────────────┤
│                                                      [上一步]          [创建工作流]      │
└───────────────────────────────────────────────────────────────────────────────────────────┘
```

### 11.9 向导组件结构

```
WizardView/
├── StepIndicator              # 步骤指示器
├── WizardStep0_Project        # 步骤0: 工作目录
│   ├── FolderSelector         # 文件夹选择器
│   └── GitStatusPanel         # Git 状态面板
├── WizardStep1_Basic          # 步骤1: 基础配置
│   ├── WorkflowNameInput      # 工作流名称
│   └── TaskCountSelector      # 任务数量选择
├── WizardStep2_Tasks          # 步骤2: 任务配置
│   ├── TaskPagination         # 任务翻页器
│   └── TaskConfigCard         # 任务配置卡片
├── WizardStep3_Models         # 步骤3: 模型配置
│   ├── ModelList              # 模型列表
│   └── AddModelModal          # 添加模型弹窗
│       ├── ApiTypeSelector    # API 类型选择
│       ├── FetchModelsButton  # 获取可用模型按钮
│       └── ModelSelector      # 模型选择器
├── WizardStep4_Terminals      # 步骤4: 终端配置
│   ├── TaskSelector           # 任务选择器
│   └── TerminalConfigList     # 终端配置列表
├── WizardStep5_Commands       # 步骤5: 斜杠命令
│   ├── CommandModeSelector    # 是否配置命令
│   └── CommandDragList        # 可拖拽命令列表
├── WizardStep6_Advanced       # 步骤6: 高级配置
│   ├── OrchestratorConfig     # 主 Agent 配置
│   ├── ErrorTerminalConfig    # 错误处理终端
│   ├── MergeTerminalConfig    # 合并终端配置
│   └── GitCommitSpec          # Git 提交规范展示
└── NavigationButtons          # 导航按钮
```

---

## 12. 状态管理设计

### 12.1 Zustand Stores 架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              Zustand Stores 架构                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐         │
│  │   workflowStore     │    │    terminalStore    │    │     wizardStore     │         │
│  │                     │    │                     │    │                     │         │
│  │ • workflows[]       │    │ • terminals[]       │    │ • currentStep       │         │
│  │ • currentWorkflow   │    │ • activeTerminals[] │    │ • formData          │         │
│  │ • workflowStatus    │    │ • terminalOutputs   │    │ • validationErrors  │         │
│  │                     │    │ • connections       │    │ • canProceed        │         │
│  └─────────┬───────────┘    └─────────┬───────────┘    └─────────────────────┘         │
│            │                          │                                                 │
│            └──────────────┬───────────┘                                                 │
│                           │                                                             │
│                           ▼                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │                            wsStore (WebSocket)                                   │   │
│  │                                                                                  │   │
│  │  • connectionStatus    • subscribe(event, handler)    • send(message)           │   │
│  │  • reconnectAttempts   • unsubscribe(event)          • reconnect()              │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                         │
│  ┌─────────────────────┐    ┌─────────────────────┐    ┌─────────────────────┐         │
│  │    modelStore       │    │    settingsStore    │    │      uiStore        │         │
│  │                     │    │                     │    │                     │         │
│  │ • configuredModels[]│    │ • cliTypes[]        │    │ • currentView       │         │
│  │ • fetchingModels    │    │ • slashPresets[]    │    │ • sidebarOpen       │         │
│  │ • validationStatus  │    │ • systemSettings    │    │ • modalStack        │         │
│  └─────────────────────┘    └─────────────────────┘    └─────────────────────┘         │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 12.2 Store 详细定义

```typescript
// stores/workflowStore.ts
interface WorkflowState {
  // 数据
  workflows: Workflow[];
  currentWorkflowId: string | null;

  // 计算属性
  currentWorkflow: Workflow | null;
  workflowsByStatus: Record<WorkflowStatus, Workflow[]>;

  // Actions
  fetchWorkflows: () => Promise<void>;
  createWorkflow: (data: CreateWorkflowDTO) => Promise<Workflow>;
  updateWorkflowStatus: (id: string, status: WorkflowStatus) => void;
  deleteWorkflow: (id: string) => Promise<void>;
  setCurrentWorkflow: (id: string) => void;
}

// stores/terminalStore.ts
interface TerminalState {
  // 数据
  terminals: Terminal[];
  terminalOutputs: Record<string, TerminalOutput[]>; // terminal_id -> outputs
  activeTerminalId: string | null;

  // WebSocket 连接
  ptyConnections: Record<string, WebSocket>; // terminal_id -> ws

  // Actions
  fetchTerminals: (workflowId: string) => Promise<void>;
  connectTerminal: (terminalId: string) => void;
  disconnectTerminal: (terminalId: string) => void;
  sendInput: (terminalId: string, input: string) => void;
  appendOutput: (terminalId: string, output: TerminalOutput) => void;
  clearOutput: (terminalId: string) => void;
  setActiveTerminal: (terminalId: string) => void;
}

// stores/modelStore.ts
interface ModelState {
  // 数据
  configuredModels: ModelConfig[];
  fetchingModels: boolean;
  availableModels: Record<string, string[]>; // apiType -> models

  // Actions
  fetchAvailableModels: (apiType: string, baseUrl: string, apiKey: string) => Promise<string[]>;
  validateModel: (config: ModelConfig) => Promise<ValidationResult>;
  saveModel: (config: ModelConfig) => Promise<void>;
  deleteModel: (id: string) => Promise<void>;
}

// stores/wizardStore.ts
interface WizardState {
  // 步骤控制
  currentStep: number;
  completedSteps: number[];

  // 表单数据
  formData: {
    step0: { projectPath: string; gitStatus: GitStatus | null };
    step1: { workflowName: string; taskCount: number; importFromBoard: boolean };
    step2: TaskConfig[];
    step3: ModelConfig[];
    step4: TerminalConfig[][];  // [taskIndex][terminalIndex]
    step5: { useCommands: boolean; commands: SlashCommand[] };
    step6: AdvancedConfig;
  };

  // 验证
  validationErrors: Record<number, string[]>;

  // Actions
  setStep: (step: number) => void;
  nextStep: () => void;
  prevStep: () => void;
  updateFormData: <T extends keyof WizardState['formData']>(
    step: T,
    data: Partial<WizardState['formData'][T]>
  ) => void;
  validateStep: (step: number) => boolean;
  resetWizard: () => void;
  submitWorkflow: () => Promise<Workflow>;
}

// stores/wsStore.ts
interface WebSocketState {
  // 连接状态
  connectionStatus: 'connecting' | 'connected' | 'disconnected' | 'error';
  reconnectAttempts: number;

  // 事件订阅
  subscriptions: Map<string, Set<(data: any) => void>>;

  // Actions
  connect: () => void;
  disconnect: () => void;
  subscribe: (event: string, handler: (data: any) => void) => () => void;
  send: (type: string, payload: any) => void;
}
```

### 12.3 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                    数据流架构                                            │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   用户操作                  Zustand Store                    后端服务                   │
│                                                                                         │
│   ┌─────────┐              ┌─────────────┐               ┌─────────────┐               │
│   │ 点击    │ ─────────→  │ dispatch    │ ──── HTTP ──→ │ REST API    │               │
│   │ 创建    │              │ action      │               │ /workflows  │               │
│   │ 工作流  │              └─────────────┘               └──────┬──────┘               │
│   └─────────┘                    │                              │                       │
│                                  │                              │                       │
│                                  ▼                              ▼                       │
│                           ┌─────────────┐               ┌─────────────┐               │
│                           │ 更新 state  │ ←───────────  │ 返回数据    │               │
│                           └─────────────┘               └─────────────┘               │
│                                  │                                                      │
│                                  ▼                                                      │
│                           ┌─────────────┐                                              │
│                           │ React 组件  │                                              │
│                           │ 自动更新    │                                              │
│                           └─────────────┘                                              │
│                                                                                         │
│   ─────────────────────────────────────────────────────────────────────────────────    │
│                                                                                         │
│   实时事件                  WebSocket                      后端服务                    │
│                                                                                         │
│   ┌─────────────┐         ┌─────────────┐               ┌─────────────┐               │
│   │ Git 提交    │ ──────→ │ Git 监测    │ ─── WS ─────→ │ wsStore     │               │
│   │ 检测到     │          │ 服务        │               │ subscribe   │               │
│   └─────────────┘         └─────────────┘               └──────┬──────┘               │
│                                                                 │                       │
│                                                                 ▼                       │
│                                                          ┌─────────────┐               │
│                                                          │ workflow    │               │
│                                                          │ Store更新   │               │
│                                                          └─────────────┘               │
│                                                                 │                       │
│                                                                 ▼                       │
│                                                          ┌─────────────┐               │
│                                                          │ 看板/流水线 │               │
│                                                          │ 视图更新    │               │
│                                                          └─────────────┘               │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 13. WebSocket 通信设计

### 13.1 通信架构

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              WebSocket 通信架构                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│   前端 (浏览器)                                           后端 (Node.js)                │
│                                                                                         │
│   ┌─────────────────────────────────────┐    ┌─────────────────────────────────────┐   │
│   │        WebSocket 连接管理            │    │        WebSocket 服务器              │   │
│   │                                     │    │                                     │   │
│   │  wsStore                            │    │  ┌─────────────────────────────┐   │   │
│   │  ┌─────────────────────────────┐   │    │  │   连接管理器                 │   │   │
│   │  │ ws://localhost:3001/events  │←──┼────┼──│   • 心跳检测                 │   │   │
│   │  └─────────────────────────────┘   │    │  │   • 自动重连                 │   │   │
│   │                                     │    │  │   • 会话管理                 │   │   │
│   │  ┌─────────────────────────────┐   │    │  └─────────────────────────────┘   │   │
│   │  │ 订阅: workflow.status       │   │    │                                     │   │
│   │  │ 订阅: terminal.output       │   │    │  ┌─────────────────────────────┐   │   │
│   │  │ 订阅: git.commit            │   │    │  │   事件广播器                 │   │   │
│   │  │ 订阅: orchestrator.status   │   │    │  │   • 频道订阅                 │   │   │
│   │  └─────────────────────────────┘   │    │  │   • 消息路由                 │   │   │
│   │                                     │    │  └─────────────────────────────┘   │   │
│   │  terminalStore                      │    │                                     │   │
│   │  ┌─────────────────────────────┐   │    │  ┌─────────────────────────────┐   │   │
│   │  │ ws://localhost:3001/pty/T1  │←──┼────┼──│   PTY 进程管理器             │   │   │
│   │  │ ws://localhost:3001/pty/T2  │   │    │  │   • node-pty                │   │   │
│   │  │ ws://localhost:3001/pty/T3  │   │    │  │   • 进程生命周期             │   │   │
│   │  └─────────────────────────────┘   │    │  └─────────────────────────────┘   │   │
│   └─────────────────────────────────────┘    └─────────────────────────────────────┘   │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 13.2 消息协议

```
消息格式 (JSON):
{
  "type": "event_type",        // 事件类型
  "payload": { ... },          // 事件数据
  "timestamp": 1705420800000,  // 时间戳
  "id": "msg_xxx"              // 消息 ID (用于确认)
}
```

### 13.3 事件类型

| 类别 | 事件 | 说明 |
|------|------|------|
| **工作流** | workflow.created | 工作流创建 |
| | workflow.status_changed | 工作流状态变更 |
| | workflow.completed | 工作流完成 |
| | workflow.failed | 工作流失败 |
| **终端** | terminal.started | 终端启动 |
| | terminal.output | 终端输出 (PTY) |
| | terminal.status_changed | 终端状态变更 |
| | terminal.completed | 终端任务完成 |
| **Git** | git.commit_detected | 检测到 Git 提交 |
| | git.branch_created | 分支创建 |
| | git.merge_started | 开始合并 |
| | git.merge_completed | 合并完成 |
| | git.merge_conflict | 合并冲突 |
| **主 Agent** | orchestrator.awakened | 主 Agent 唤醒 |
| | orchestrator.sleeping | 主 Agent 休眠 |
| | orchestrator.processing | 主 Agent 处理中 |
| | orchestrator.decision | 主 Agent 决策 |
| **系统** | system.heartbeat | 心跳 |
| | system.error | 系统错误 |

### 13.4 事件示例

```json
// 终端输出事件
{
  "type": "terminal.output",
  "payload": {
    "terminal_id": "t_abc123",
    "output": "\u001b[32m✓\u001b[0m File saved: src/login.tsx",
    "stream": "stdout"
  },
  "timestamp": 1705420800000
}

// Git 提交检测事件
{
  "type": "git.commit_detected",
  "payload": {
    "commit_hash": "a1b2c3d",
    "branch": "feat/login",
    "terminal_id": "t_abc123",
    "status": "completed",
    "metadata": {
      "workflow_id": "wf_xyz789",
      "task_id": "task_def456",
      "files_changed": [
        {"path": "src/login.tsx", "additions": 45, "deletions": 0}
      ],
      "next_action": "continue"
    }
  },
  "timestamp": 1705420800000
}

// 主 Agent 决策事件
{
  "type": "orchestrator.decision",
  "payload": {
    "workflow_id": "wf_xyz789",
    "decision": "start_next_terminal",
    "target_terminal": "t_def456",
    "reason": "Terminal t_abc123 completed successfully, proceeding to review phase",
    "command": "/review 检查登录功能的代码质量和安全性"
  },
  "timestamp": 1705420800000
}
```

---

## 附录

### A. 支持的 CLI 列表

- Claude Code
- Gemini CLI
- Codex
- Amp
- Cursor Agent
- Qwen Code
- Copilot
- Droid
- Opencode

### B. 系统内置斜杠命令

| 命令 | 说明 |
|------|------|
| /write-code | 编写功能代码 |
| /review | 代码审计，检查安全性和代码质量 |
| /fix-issues | 修复发现的问题 |
| /test | 运行测试 |
| /refactor | 重构代码 |
| /document | 编写文档 |

---

*文档版本: 2.0*
*创建日期: 2026-01-16*
*更新日期: 2026-01-17*
*更新内容: 添加完整的前端界面设计（三视图、分步向导、状态管理、WebSocket 通信）*
