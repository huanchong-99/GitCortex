# Phase 18.1: 测试技术债务清理

> **创建日期:** 2026-01-29
> **状态:** 待开始
> **优先级:** 中（CI 已通过，但测试覆盖率降低）
> **前置条件:** Phase 18.0 基线修复完成

## 背景

在 Phase 18.0 基线修复过程中，为了让 CI 通过，我们采取了以下临时措施：
1. CI 改为只运行库测试 (`--lib`)，排除了有编译错误的集成测试
2. 标记了 9 个失败的库测试为 `#[ignore]`

这些是技术债务，需要在本阶段清理。

---

## 问题分析（来源：Codex MCP 分析）

### 被忽略的库测试（9个）

| 测试名称 | 文件位置 | 失败原因 |
|----------|----------|----------|
| `test_slugify_special_chars` | `services/src/utils/mod.rs` | `slugify` 只在空白时插入连字符，特殊符号直接丢弃，导致 `"Hello@World!"` 变成 `"helloworld"` 而不是 `"hello-world"` |
| `test_slugify_chinese_chars` | `services/src/utils/mod.rs` | `char::is_alphanumeric()` 会把 CJK 也当作字母数字，中文被保留而非移除 |
| `test_render_missing_variable` | `services/src/services/template_renderer.rs` | 错误文案是 `"Template rendering failed: ..."`，测试断言 `"Rendering failed"`，字符串不匹配 |
| `test_terminal_startup_sequence_succeeds` | `services/src/services/orchestrator/terminal_coordinator_test.rs` | 测试用手工 `CREATE TABLE` 创建表，与真实迁移冲突；手工表缺字段导致 `FromRow` 失败 |
| `test_terminal_startup_switches_models_serially` | `services/src/services/orchestrator/terminal_coordinator_test.rs` | 同上，且依赖插入顺序与查询排序完全一致 |
| `test_empty_workflow_no_terminals` | `services/src/services/orchestrator/terminal_coordinator_test.rs` | 同上，失败点在 DB 初始化阶段 |
| `test_single_terminal_startup` | `services/src/services/orchestrator/terminal_coordinator_test.rs` | 同上 |
| `test_handle_git_event_terminal_completed` | `services/src/services/orchestrator/tests.rs` | 测试里的 `---METADATA---` 是 JSON + camelCase，而 `parse_commit_metadata` 只支持逐行 KV 格式 |
| `test_handle_git_event_workflow_mismatch` | `services/src/services/orchestrator/tests.rs` | 同上，解析失败导致未进入业务逻辑 |

### 集成测试编译错误（12个文件）

| 问题类型 | 影响文件 | 修复方向 |
|----------|----------|----------|
| `SqlitePoolOptions` 导入 | `terminal_binding_test.rs`, `terminal_lifecycle_test.rs` | 改为 `sqlx::sqlite::SqlitePoolOptions` |
| 类型注解缺失 | `terminal_integration.rs`, `terminal_lifecycle_test.rs` | `.bind(None)` 改为 `Option::<String>::None` |
| 方法路径变化 | `terminal_logging_test.rs`, `merge_coordinator_test.rs` | 对齐当前公开 API 路径 |
| 借用检查错误 | `git_watcher_integration_test.rs` | 提前 `clone` 或调整闭包捕获 |

---

## 任务清单

### P0 - 集成测试编译错误修复（阻塞 CI 完整测试）

| Task | 目标描述 | 状态 | 完成时间 |
|------|----------|------|----------|
| 18.1.1 | 修复 SqlitePoolOptions 导入路径 - 统一使用 `sqlx::sqlite::SqlitePoolOptions` | ⬜ |  |
| 18.1.2 | 修复类型注解问题 - 为 `.bind(None)` 添加显式类型 | ⬜ |  |
| 18.1.3 | 修复模块路径问题 - 对齐 services crate 公开 API | ⬜ |  |
| 18.1.4 | 修复借用检查错误 - 调整 `git_watcher_integration_test.rs` 中的闭包捕获 | ⬜ |  |
| 18.1.5 | 验证集成测试编译通过 - `cargo test -p services --tests --no-run` | ⬜ |  |

### P1 - 简单逻辑修复（最小改动）

| Task | 目标描述 | 状态 | 完成时间 |
|------|----------|------|----------|
| 18.1.6 | 修复 `slugify` 函数 - 特殊字符应替换为连字符而非直接丢弃 | ⬜ |  |
| 18.1.7 | 修复 `slugify` 函数 - 使用 `char::is_ascii_alphanumeric()` 替代 `is_alphanumeric()` 以排除 CJK | ⬜ |  |
| 18.1.8 | 修复 `test_render_missing_variable` - 更新断言字符串匹配实际错误文案 | ⬜ |  |
| 18.1.9 | 统一 commit metadata 格式 - 确定使用 KV 还是 JSON，同步修改解析逻辑或测试用例 | ⬜ |  |

### P2 - 测试基础设施重构

| Task | 目标描述 | 状态 | 完成时间 |
|------|----------|------|----------|
| 18.1.10 | 重构 terminal_coordinator_test DB 初始化 - 使用 in-memory + 真实迁移替代手工建表 | ⬜ |  |
| 18.1.11 | 补齐 terminal_coordinator_test seed 数据 - 确保所有必需字段存在 | ⬜ |  |
| 18.1.12 | 修复测试顺序依赖 - 确保测试不依赖特定的插入/查询顺序 | ⬜ |  |

### P3 - CI 恢复与验证

| Task | 目标描述 | 状态 | 完成时间 |
|------|----------|------|----------|
| 18.1.13 | 移除 `#[ignore]` 属性 - 逐步解禁已修复的测试 | ⬜ |  |
| 18.1.14 | 恢复 CI 完整测试 - 将 `--lib` 改回 `--workspace` | ⬜ |  |
| 18.1.15 | 全量回归验证 - 确保所有测试通过 | ⬜ |  |

---

## 验收标准

1. **编译通过**: `cargo test --workspace --no-run` 无编译错误
2. **测试通过**: `cargo test --workspace` 全部通过，无 `#[ignore]` 测试
3. **CI 恢复**: GitHub Actions Baseline Check 使用完整测试命令

---

## 技术决策点

### 1. Commit Metadata 格式选择

**选项 A: 保持 KV 格式**
```
---METADATA---
workflow_id: xxx
terminal_id: xxx
status: completed
---END METADATA---
```
- 优点：简单易读，现有解析逻辑已实现
- 缺点：扩展性差，需要修改测试用例

**选项 B: 改用 JSON 格式**
```
---METADATA---
{"workflowId": "xxx", "terminalId": "xxx", "status": "completed"}
---END METADATA---
```
- 优点：扩展性好，与前端 camelCase 一致
- 缺点：需要修改解析逻辑

**建议**: 选项 A（保持 KV 格式），修改测试用例以匹配现有实现。

### 2. Slugify 函数行为

**当前行为**: 特殊字符直接丢弃
**期望行为**: 特殊字符替换为连字符

**修复方案**:
```rust
// 修改前
if c.is_alphanumeric() { ... } else { /* 丢弃 */ }

// 修改后
if c.is_ascii_alphanumeric() { result.push(c.to_ascii_lowercase()); }
else if !result.ends_with('-') { result.push('-'); }
```

---

## 相关文件

- `crates/services/src/utils/mod.rs` - slugify 函数
- `crates/services/src/services/template_renderer.rs` - 模板渲染器
- `crates/services/src/services/git_watcher.rs` - commit metadata 解析
- `crates/services/src/services/orchestrator/terminal_coordinator_test.rs` - 终端协调器测试
- `crates/services/src/services/orchestrator/tests.rs` - 编排器测试
- `crates/services/tests/*.rs` - 集成测试文件
- `.github/workflows/baseline-check.yml` - CI 工作流程
