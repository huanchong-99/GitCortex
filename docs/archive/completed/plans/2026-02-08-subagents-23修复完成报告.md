# 2026-02-08 Sub-agents（23人）全量修复完成报告

## 1. 执行概览

- 执行方式：Sub-agents 并行修复（5 FE + 8 BE + 10 FS）
- 修复范围来源：`docs/archive/pending/plans/codex项目完整分析.md`
- 目标：修复报告中的直接 Bug、逻辑问题与关键代码质量缺陷
- 结果：P0/P1/P2 共 35 项问题均已落地修复并完成定向验证

## 2. 问题修复映射（摘要）

### P0（14 项）

- P0-01~P0-02（Prompt 检测/auto_confirm 链路）
  - `crates/services/src/services/terminal/prompt_detector.rs`
  - `crates/services/src/services/terminal/prompt_watcher.rs`
  - `crates/services/src/services/terminal/launcher.rs`
  - `crates/services/src/services/orchestrator/prompt_handler.rs`

- P0-03~P0-05（WS payload 契约）
  - `crates/server/src/routes/workflow_events.rs`
  - `frontend/src/stores/wsStore.ts`
  - `frontend/src/stores/__tests__/wsStore.test.ts`

- P0-06（publish/broadcast 通道统一）
  - `crates/services/src/services/orchestrator/message_bus.rs`
  - `crates/services/src/services/orchestrator/agent.rs`
  - `crates/server/src/routes/event_bridge.rs`
  - `crates/services/src/services/orchestrator/tests.rs`

- P0-07~P0-09（workflow 状态机/作用域）
  - `crates/server/src/routes/workflows.rs`

- P0-10~P0-11（路径边界/命令注入）
  - `crates/server/src/routes/git.rs`
  - `crates/server/src/routes/task_attempts/codex_setup.rs`

- P0-12（Open Editor 目录误判）
  - `crates/server/src/routes/projects.rs`
  - `crates/server/src/routes/repo.rs`
  - `crates/services/src/services/config/editor/mod.rs`

- P0-13（MCP TaskServer Token 场景）
  - `crates/server/src/mcp/task_server.rs`

- P0-14（start_workflow 并发重复启动）
  - `crates/services/src/services/orchestrator/runtime.rs`

### P1（15 项）

- P1-01~P1-04（terminal stop/kill/logger/session）
  - `crates/services/src/services/terminal/launcher.rs`
  - `crates/services/src/services/terminal/process.rs`

- P1-05（ws send 串发）
  - `frontend/src/stores/wsStore.ts`

- P1-06（WorkflowDebug ws/wss）
  - `frontend/src/pages/WorkflowDebug.tsx`

- P1-07~P1-08（TaskCard/TaskMutations 缓存一致性）
  - `frontend/src/components/tasks/TaskCard.tsx`
  - `frontend/src/hooks/useTaskMutations.ts`

- P1-09~P1-10（MCP 空保存/API 结构化错误）
  - `frontend/src/pages/settings/McpSettings.tsx`
  - `frontend/src/lib/api.ts`

- P1-11~P1-13（错误语义与映射/search_repo）
  - `crates/server/src/error.rs`
  - `crates/server/src/routes/task_attempts.rs`
  - `crates/server/src/routes/config.rs`
  - `crates/server/src/routes/repo.rs`

- P1-14（config path 空值 panic）
  - `crates/server/src/routes/config.rs`

- P1-15（dropped 进程过滤）
  - `crates/db/src/models/task.rs`
  - `crates/db/src/models/workspace.rs`
  - `crates/db/.sqlx/*`

### P2（6 项）

- P2-01（migration 外键恢复）
  - `crates/db/migrations/20260208010000_backfill_terminal_auto_confirm.sql`

- P2-02（command 参数边界）
  - `crates/executors/src/command.rs`

- P2-03（plain_text_processor Split 边界）
  - `crates/executors/src/logs/plain_text_processor.rs`

- P2-04（Workflow 状态 UI 一致性）
  - `frontend/src/pages/Workflows.tsx`

- P2-05（remote 能力门禁）
  - `frontend/src/pages/settings/OrganizationSettings.tsx`
  - `frontend/src/components/org/RemoteProjectItem.tsx`
  - `frontend/src/pages/settings/organizationRemoteCapability.ts`

- P2-06（merge 闭环）
  - `frontend/src/hooks/useWorkflows.ts`
  - `frontend/src/pages/Workflows.tsx`
  - `crates/server/src/routes/workflows.rs`

## 3. 关键测试与验证

- Rust 编译：`cargo check -p db -p executors -p services -p server` ✅
- 前端类型：`pnpm -C frontend run check` ✅
- 前端关键回归（9 文件 59 用例）：✅
- 后端关键回归：`events_test`、`workflow_contract`、`workflow_events`、`workflow_guard_tests`、`error::tests`、`task_server::tests`、`path_boundary_tests` 等全部通过 ✅
- 终端链路定向回归：`prompt_detector`、`prompt_watcher`、`prompt_handler`、`stop_all`、`kill_terminal`、`logger flush`、`get_handle` 全部通过 ✅

## 4. 备注

- 本轮聚焦“修复审计报告问题 + 相关代码质量问题”，未扩展到报告外的大规模重构。
- 当前仍有仓库历史 warning（与本轮修复目标无关），不影响本轮验证通过。

