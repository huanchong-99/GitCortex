# Phase 18.3-18.6 实施计划

> **创建时间:** 2026-01-30
> **工作区:** E:/GitCortex-phase-18-perf
> **分支:** feature/phase-18-performance

## 概述

完成 Phase 18 剩余任务，实现全链路测试与发布就绪。

---

## Task 18.3 - 性能与稳定性压测

### 18.3.1 终端并发连接数测试

**测试用例:**
- `test_terminal_concurrent_connections_100` - 100并发连接成功率 ≥ 99%
- `test_terminal_concurrent_connections_500` - 500并发连接成功率 ≥ 95%
- `test_terminal_connection_latency_p95` - 连接建立P95 ≤ 500ms
- `test_terminal_reconnection_recovery` - 断连恢复时间 ≤ 5s

**实施步骤:**
1. 创建 `crates/server/tests/performance/` 目录
2. 实现并发连接压测脚本
3. 添加连接指标埋点（连接数、失败原因、握手时长）
4. 运行分级压测，输出性能报告

### 18.3.2 WebSocket消息吞吐量测试

**测试用例:**
- `test_ws_single_connection_throughput` - 单连接TPS ≥ 1000
- `test_ws_multi_connection_throughput` - 50连接总TPS ≥ 10000
- `test_ws_message_latency_p95` - P95消息延迟 ≤ 100ms
- `test_ws_broadcast_performance` - 广播消息延迟 ≤ 200ms

**实施步骤:**
1. 构建WS压测工具（生产者/消费者模式）
2. 定义消息大小分布（小/中/大包）
3. 采集端到端延迟与队列堆积指标
4. 确定吞吐拐点

### 18.3.3 数据库查询性能基准测试

**测试用例:**
- `test_db_workflow_list_performance` - 列表查询P95 ≤ 50ms
- `test_db_workflow_detail_performance` - 详情查询P95 ≤ 30ms
- `test_db_concurrent_write_performance` - 并发写入无死锁
- `test_db_index_effectiveness` - 索引命中率 ≥ 95%

**实施步骤:**
1. 选取关键SQL路径
2. 生成基准数据集（100/1000/10000条）
3. 建立基准测试脚本
4. 输出索引/查询计划审计报告

### 18.3.4 内存/CPU使用监控

**测试用例:**
- `test_memory_no_leak_under_load` - 压测期间内存无持续爬升
- `test_cpu_peak_under_threshold` - CPU峰值 ≤ 80%
- `test_handle_count_stable` - 句柄数稳定

**实施步骤:**
1. 接入监控指标（CPU、RSS、Heap、线程/句柄）
2. 在压测脚本中标记阶段性采样
3. 设置报警阈值

---

## Task 18.4 - 安全与配置审计

### 18.4.1 API密钥加密存储验证

**测试用例:**
- `test_api_key_encrypted_at_rest` - 数据库内密钥不可明文 ✅ (已有)
- `test_api_key_decryption_correct` - 加解密流程正确 ✅ (已有)
- `test_api_key_wrong_key_fails` - 错误密钥不可解密
- `test_api_key_rotation` - 密钥轮换测试

**实施步骤:**
1. 扩展现有安全测试
2. 添加密钥轮换测试
3. 验证存储字段熵值

### 18.4.2 权限控制检查

**测试用例:**
- `test_workflow_access_control` - 工作流访问控制
- `test_cross_project_access_denied` - 跨项目访问被阻断
- `test_api_rate_limiting` - API速率限制生效

**实施步骤:**
1. 明确权限矩阵
2. 编写API集成测试
3. 验证资源隔离

### 18.4.3 日志脱敏验证

**测试用例:**
- `test_log_no_api_key_exposure` - 日志不含API密钥
- `test_log_no_token_exposure` - 日志不含Token
- `test_log_sensitive_field_masked` - 敏感字段被mask

**实施步骤:**
1. 定义敏感字段清单
2. 加入日志过滤器
3. 扫描日志输出断言

### 18.4.4 输入验证与SQL注入防护

**测试用例:**
- `test_sql_injection_prevention` - SQL注入防护
- `test_xss_prevention` - XSS防护
- `test_input_boundary_validation` - 边界输入验证

**实施步骤:**
1. 建立恶意payload测试集
2. 执行集成测试
3. 审计ORM参数化用法

---

## Task 18.5 - 使用文档与运维手册完善

### 18.5.1 用户使用指南

**内容:**
- 安装与配置
- 快速开始
- 工作流创建与管理
- 终端调试
- 常见问题排查

### 18.5.2 运维手册

**内容:**
- 部署架构
- 配置参数说明
- 监控与告警
- 备份与恢复
- 故障排查

### 18.5.3 API文档

**内容:**
- OpenAPI/Swagger规范
- 请求/响应示例
- 错误码说明

---

## Task 18.6 - 发布与回滚清单

### 18.6.1 版本号管理

**内容:**
- SemVer规范
- CHANGELOG维护
- Git Tag策略

### 18.6.2 数据库迁移策略

**内容:**
- 迁移脚本验证
- 回滚脚本准备
- 数据一致性校验

### 18.6.3 备份与回滚方案

**内容:**
- 备份脚本
- 恢复流程
- 演练记录

---

## 文件结构

```
crates/server/tests/
├── performance/
│   ├── mod.rs
│   ├── terminal_perf_test.rs      # 终端性能测试
│   ├── websocket_perf_test.rs     # WebSocket性能测试
│   └── database_perf_test.rs      # 数据库性能测试
├── security/
│   ├── mod.rs
│   ├── encryption_test.rs         # 加密测试
│   ├── access_control_test.rs     # 访问控制测试
│   ├── log_sanitization_test.rs   # 日志脱敏测试
│   └── injection_prevention_test.rs # 注入防护测试
└── security_test.rs               # 现有安全测试 (保留)

docs/
├── USER_GUIDE.md                  # 用户使用指南
├── OPERATIONS_MANUAL.md           # 运维手册
├── API_REFERENCE.md               # API参考
├── RELEASE_CHECKLIST.md           # 发布清单
└── CHANGELOG.md                   # 变更日志
```

---

## 执行顺序

1. **Phase 1**: Task 18.3 性能测试 (并行开发)
2. **Phase 2**: Task 18.4 安全审计 (并行开发)
3. **Phase 3**: Task 18.5 文档完善
4. **Phase 4**: Task 18.6 发布清单

---

## 验收标准

- [ ] 所有性能测试通过，指标达标
- [ ] 所有安全测试通过，无漏洞
- [ ] 文档完整，可指导新用户
- [ ] 发布清单完备，可执行回滚
