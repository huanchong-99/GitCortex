# Phase 20: è‡ªåŠ¨åŒ–åè°ƒæ ¸å¿ƒï¼ˆOrchestrator è‡ªåŠ¨ä»»åŠ¡æ´¾å‘ï¼‰

> **åˆ›å»ºæ—¥æœŸ:** 2026-02-04
> **çŠ¶æ€:** ğŸ“‹ å¾…å®æ–½
> **ä¼˜å…ˆçº§:** ğŸ”´ é«˜ï¼ˆæ ¸å¿ƒåŠŸèƒ½å®ç°ï¼‰
> **å‰ç½®æ¡ä»¶:** Phase 18.5 è®¾è®¡æ–‡æ¡£å¯¹é½ä¿®å¤å®Œæˆ

---

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 èƒŒæ™¯

æ ¹æ®è®¾è®¡æ–‡æ¡£ `docs/developed/plans/2026-01-16-orchestrator-design.md`ï¼ŒOrchestrator åº”è¯¥åœ¨ workflow è¿›å…¥ `running` çŠ¶æ€åè‡ªåŠ¨å‘ç»ˆç«¯æ´¾å‘ä»»åŠ¡ã€‚ä½†å½“å‰å®ç°å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

- `execute_instruction` åªå¤„ç† `SendToTerminal/CompleteWorkflow/FailWorkflow`ï¼Œ**æœªå¤„ç† `StartTask`**
- `execute_slash_commands` åªè®°å½•å¯¹è¯ï¼Œä¸ä¼šä¸‹å‘æŒ‡ä»¤åˆ°ç»ˆç«¯
- Orchestrator å¯åŠ¨åä¸ä¼šè‡ªåŠ¨æ´¾å‘ä»»åŠ¡ï¼Œéœ€è¦æ‰‹åŠ¨æ“ä½œ

### 1.2 ç›®æ ‡

å®ç°"å¯åŠ¨ç»ˆç«¯åè‡ªåŠ¨å¼€å‘"çš„æ ¸å¿ƒåŠŸèƒ½ï¼š
- Workflow è¿›å…¥ `running` çŠ¶æ€åè‡ªåŠ¨æ´¾å‘é¦–ä¸ªç»ˆç«¯ä»»åŠ¡
- ç»ˆç«¯å®Œæˆåè‡ªåŠ¨è§¦å‘ä¸‹ä¸€ä¸ªç»ˆç«¯
- æ–œæ å‘½ä»¤å¯è‡ªåŠ¨æ‰§è¡Œå¹¶è§¦å‘æ´¾å‘

---

## 2. ä»»åŠ¡æ‹†åˆ†

### 2.1 P0 - è‡ªåŠ¨æ´¾å‘è§¦å‘ç‚¹

| Task | ç›®æ ‡æè¿° | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|----------|------|----------|
| 20.1 | å®šä¹‰æ´¾å‘è§¦å‘ç‚¹ - ç¡®è®¤ `ready -> running` å…¥å£ä»…ä¸º `/api/workflows/:id/start` | â¬œ |  |
| 20.2 | åœ¨ Orchestrator `run()` åˆå§‹é˜¶æ®µæ‰§è¡Œè‡ªåŠ¨æ´¾å‘é€»è¾‘ | â¬œ |  |
| 20.3 | å¢åŠ "æ´¾å‘å¤±è´¥"å®¹é”™ä¸é‡è¯•ç­–ç•¥ | â¬œ |  |

### 2.2 P1 - ä»»åŠ¡çŠ¶æ€åˆå§‹åŒ–

| Task | ç›®æ ‡æè¿° | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|----------|------|----------|
| 20.4 | åŸºäº `workflow_task` ä¸ `terminal` è¡¨åŠ è½½æ¯ä¸ªä»»åŠ¡çš„ç»ˆç«¯åºåˆ— | â¬œ |  |
| 20.5 | ä½¿ç”¨ `OrchestratorState::init_task` åˆå§‹åŒ– `TaskExecutionState` | â¬œ |  |
| 20.6 | ä¿å­˜ `current_terminal_index` ä¸ `total_terminals` çŠ¶æ€ | â¬œ |  |

### 2.3 P2 - è‡ªåŠ¨æ´¾å‘ç¬¬ä¸€ä¸ªç»ˆç«¯

| Task | ç›®æ ‡æè¿° | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|----------|------|----------|
| 20.7 | ä» `workflow_task` ä¸ç¬¬ä¸€ä¸ª `terminal` ç”ŸæˆæŒ‡ä»¤æ–‡æœ¬ | â¬œ |  |
| 20.8 | é€šè¿‡ `BusMessage::TerminalMessage` å‘é€åˆ° PTY ä¼šè¯ | â¬œ |  |
| 20.9 | è‹¥ç»ˆç«¯æ—  `pty_session_id`ï¼Œè®°å½•é”™è¯¯å¹¶æ ‡è®°ä»»åŠ¡å¤±è´¥æˆ–è¿›å…¥é‡è¯• | â¬œ |  |

### 2.4 P3 - execute_instruction å¤„ç† StartTask

| Task | ç›®æ ‡æè¿° | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|----------|------|----------|
| 20.10 | åœ¨ `OrchestratorInstruction` æšä¸¾ä¸­æ·»åŠ  `StartTask` å˜ä½“ | â¬œ |  |
| 20.11 | å®ç° `execute_instruction` å¯¹ `StartTask` çš„å¤„ç†é€»è¾‘ | â¬œ |  |
| 20.12 | `StartTask` å¯æºå¸¦ `task_id` ä¸ `instruction` æ–‡æœ¬ | â¬œ |  |

### 2.5 P4 - è‡ªåŠ¨è§¦å‘ä¸‹ä¸€ä¸ªç»ˆç«¯

| Task | ç›®æ ‡æè¿° | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|----------|------|----------|
| 20.13 | åœ¨ `handle_terminal_completed` ä¸­æ¨è¿› `current_terminal_index` | â¬œ |  |
| 20.14 | å¯¹åŒä¸€ task çš„ä¸‹ä¸€ä¸ª terminal è‡ªåŠ¨æ´¾å‘ | â¬œ |  |
| 20.15 | æ‰€æœ‰ terminals å®Œæˆåæ ‡è®° task å®Œæˆ | â¬œ |  |
| 20.16 | æ‰€æœ‰ tasks å®Œæˆåè§¦å‘åˆå¹¶æˆ–å®Œæˆæµç¨‹ | â¬œ |  |

### 2.6 P5 - æ–œæ å‘½ä»¤è‡ªåŠ¨æ‰§è¡Œ

| Task | ç›®æ ‡æè¿° | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|----------|------|----------|
| 20.17 | åœ¨ `execute_slash_commands` ä¸­å¯¹ LLM è¿”å›å†…å®¹æ‰§è¡Œ `execute_instruction` | â¬œ |  |
| 20.18 | å¼•å…¥"æ— æŒ‡ä»¤å“åº”"çš„å®‰å…¨å…œåº•å¤„ç† | â¬œ |  |

### 2.7 P6 - æµ‹è¯•ä¸å›å½’

| Task | ç›®æ ‡æè¿° | çŠ¶æ€ | å®Œæˆæ—¶é—´ |
|------|----------|------|----------|
| 20.19 | æ–°å¢ Orchestrator è‡ªåŠ¨æ´¾å‘å•æµ‹ | â¬œ |  |
| 20.20 | æ–°å¢ `StartTask` æŒ‡ä»¤æ‰§è¡Œå•æµ‹ | â¬œ |  |
| 20.21 | æ–°å¢"ç»ˆç«¯å®Œæˆ -> ä¸‹ä¸€ç»ˆç«¯æ´¾å‘"å•æµ‹ | â¬œ |  |
| 20.22 | æ–°å¢ç»ˆç«¯æ—  PTY ä¼šè¯æ—¶çš„é”™è¯¯è·¯å¾„æµ‹è¯• | â¬œ |  |

---

## 3. å½±å“æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `crates/services/src/services/orchestrator/agent.rs` | ä¿®æ”¹ | æ·»åŠ è‡ªåŠ¨æ´¾å‘é€»è¾‘ |
| `crates/services/src/services/orchestrator/state.rs` | ä¿®æ”¹ | æ·»åŠ ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ç®¡ç† |
| `crates/services/src/services/orchestrator/types.rs` | ä¿®æ”¹ | æ·»åŠ  `StartTask` æŒ‡ä»¤ç±»å‹ |
| `crates/services/src/services/orchestrator/tests.rs` | æ–°å¢ | è‡ªåŠ¨æ´¾å‘æµ‹è¯• |

---

## 4. éªŒæ”¶æ ‡å‡†

### 4.1 åŠŸèƒ½éªŒæ”¶

- [ ] Workflow è¿›å…¥ `running` åè‡ªåŠ¨æ´¾å‘é¦–ä¸ªç»ˆç«¯ä»»åŠ¡
- [ ] `StartTask` æŒ‡ä»¤å¯è§¦å‘ç»ˆç«¯ä»»åŠ¡æ‰§è¡Œ
- [ ] ç»ˆç«¯å®Œæˆåè‡ªåŠ¨æ¨è¿›åˆ°ä¸‹ä¸€ä¸ªç»ˆç«¯
- [ ] æ–œæ å‘½ä»¤å¯è‡ªåŠ¨è§¦å‘æ´¾å‘é€»è¾‘
- [ ] æ´¾å‘å¤±è´¥æ—¶æœ‰åˆç†çš„é”™è¯¯å¤„ç†

### 4.2 æµ‹è¯•éªŒæ”¶

- [ ] æ‰€æœ‰ç°æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ–°å¢ 4 ä¸ªè‡ªåŠ¨æ´¾å‘ç›¸å…³æµ‹è¯•
- [ ] é”™è¯¯è·¯å¾„æµ‹è¯•è¦†ç›–

---

## 5. é£é™©ä¸ä¾èµ–

### 5.1 é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|----------|
| PTY ä¼šè¯æœªå°±ç»ª | é«˜ | æ·»åŠ é‡è¯•æœºåˆ¶å’Œè¶…æ—¶å¤„ç† |
| å¹¶å‘ä»»åŠ¡çŠ¶æ€å†²çª | ä¸­ | ä½¿ç”¨é”æˆ–åŸå­æ“ä½œä¿æŠ¤çŠ¶æ€ |

### 5.2 ä¾èµ–

- Phase 18.5 Zustand stores å®ç°ï¼ˆå‰ç«¯çŠ¶æ€åŒæ­¥ï¼‰
- Phase 15 PTY è¿›ç¨‹ç®¡ç†ï¼ˆç»ˆç«¯ä¼šè¯ï¼‰

---

## 6. å‚è€ƒæ–‡æ¡£

- è®¾è®¡æ–‡æ¡£: `docs/developed/plans/2026-01-16-orchestrator-design.md` ç¬¬ 6 èŠ‚
- ç›¸å…³ä»£ç : `crates/services/src/services/orchestrator/`
