# Phase 18.5: 设计文档对齐修复

> **创建日期:** 2026-01-31
> **更新日期:** 2026-02-04
> **状态:** 🔶 进行中（P0 已完成，P1/P2 待完成）
> **优先级:** 🔴 高（核心功能偏差修复）
> **来源:** 设计文档审计发现 48 个偏差

---

## 1. 背景与目标

### 1.1 背景

在对 `docs/developed/plans/2026-01-16-orchestrator-design.md` 设计文档与前端实现进行全面对比审计后，发现 **48 个偏差**，涵盖：

- **7 项严重偏差**（核心功能缺失，阻断使用）
- **7 项中等偏差**（功能完整性不足）
- **34 项轻微偏差**（UI/UX 细节）

### 1.2 目标

在不引入新功能的前提下，修复与设计文档的关键偏差，优先恢复核心交互与架构一致性，确保后续阶段能在正确的基础上迭代。

### 1.3 范围

- ✅ 覆盖 7 项严重偏差 + 7 项中等偏差作为主战场
- ✅ 轻微偏差作为收尾与体验完整性补齐
- ❌ 不做新功能扩展
- ❌ 不改视觉风格体系
- ✅ 仅对齐设计行为与结构

---

## 2. 偏差清单

### 2.1 P0 - 严重偏差（核心功能缺失）— ✅ 全部完成

| ID | 偏差描述 | 设计要求 | 状态 | 修复说明 |
|----|----------|----------|------|----------|
| P0-1 | 终端数量限制 | 用户可自定义终端数量 | ✅ | 支持 1-10，快捷按钮 + 自定义输入 |
| P0-2 | 调试视图无交互 | PTY + xterm 原生交互 | ✅ | 接入 TerminalEmulator + PTY WebSocket |
| P0-3 | 看板无拖拽 | 任务卡片拖拽 | ✅ | @dnd-kit 实现跨列拖拽 |
| P0-4 | WebSocket 架构不一致 | `{type,payload,timestamp,id}` + 多事件类型 | ✅ | wsStore 实现完整协议 |
| P0-5 | 状态管理未实现 | Zustand stores 架构 | ✅ | 6 个核心 stores 已创建 |
| P0-6 | API 调用未实现 | 真实 API 获取/验证模型 | ✅ | modelStore.fetchModels/verifyModel |
| P0-7 | CLI 支持不足 | 9 个 CLI 类型 | ✅ | constants.ts 包含全部 9 个 CLI |

### 2.2 P1 - 中等偏差（功能完整性不足）— ⚠️ 部分完成

| ID | 偏差描述 | 设计要求 | 状态 | 说明 |
|----|----------|----------|------|------|
| P1-1 | Git 提交规范不一致 | METADATA 格式 | ❌ | 仍使用 Conventional Commit |
| P1-2 | 路由结构不一致 | `/wizard/project` 等分步路由 | ❌ | 仍是单一 `/wizard` 路由 |
| P1-3 | 设置页面结构不一致 | `/settings/cli,models,presets` | ❌ | 未改为设计结构 |
| P1-4 | 视图切换导航缺失 | 全局 [看板][流水线][调试] 切换 | ✅ | NewDesignLayout 已实现 |
| P1-5 | 终端活动面板功能不足 | 仅 Working/Waiting + 3-5行输出 + 可折叠 | ❌ | 待验证 |
| P1-6 | 流水线视图信息缺失 | 任务名+分支+命令+连接线 | ❌ | 待验证 |
| P1-7 | Step4/Step5 交互不符 | 拖拽排序 + 安装命令 + 重检按钮 | ❌ | 待验证 |

### 2.3 P2 - 轻微偏差（UI/UX 细节）— ⬜ 未开始

| ID | 偏差描述 | 涉及文件 | 状态 |
|----|----------|----------|------|
| P2-1 | StatusBar 硬编码 | `StatusBar.tsx` | ⬜ |
| P2-2 | OrchestratorHeader Token 固定 | `OrchestratorHeader.tsx` | ⬜ |
| P2-3 | TaskCard 终端状态点无区分 | `TerminalDots.tsx` | ⬜ |
| P2-4 | MergeTerminalNode 缺少 CLI/模型 | `MergeTerminalNode.tsx` | ⬜ |
| P2-5 | TerminalDetailPanel 无输出 | `TerminalDetailPanel.tsx` | ⬜ |
| P2-6 | Step0 缺少拖拽/选择其他文件夹 | `Step0Project.tsx` | ⬜ |
| P2-7 | Step0 缺少初始化说明 | `Step0Project.tsx` | ⬜ |
| P2-8 | Step1 任务数上限受限 | `Step1Basic.tsx` | ⬜ |
| P2-9 | Step1 额外 description 字段 | `Step1Basic.tsx` | ⬜ |
| P2-10 | Step2 缺少 Markdown 支持 | `Step2Tasks.tsx` | ⬜ |
| P2-11 | Step3 缺少 API Key 显示切换 | `Step3Models.tsx` | ✅ |
| P2-12 | Step3 缺少获取数量状态 | `Step3Models.tsx` | ⬜ |
| P2-13 | Step5 缺少新建命令按钮 | `Step5Commands.tsx` | ⬜ |
| P2-14 | 看板缺少 starting/merging 列 | `WorkflowKanbanBoard.tsx` | ⬜ |
| P2-15 | 流水线缺少底部提示 | `Pipeline.tsx` | ⬜ |
| P2-16 | 调试视图缺少直接开始按钮 | `WorkflowDebugPage.tsx` | ⬜ |
| P2-17 | 调试视图缺少底部状态栏 | `WorkflowDebugPage.tsx` | ⬜ |
| P2-18 | 终端活动面板缺少最后更新时间 | `TerminalActivityPanel.tsx` | ⬜ |
| P2-19 | Step1 导入功能不完整 | `Step1Basic.tsx` | ⬜ |
| P2-20 | Step4 缺少执行顺序说明 | `Step4Terminals.tsx` | ⬜ |
| P2-21 | 流水线缺少任务间连接线 | `TaskPipelineGrid.tsx` | ⬜ |
| P2-22 | 终端节点缺少斜杠命令显示 | `TerminalNode.tsx` | ⬜ |
| P2-23 | WebSocket 缺少心跳机制 | `websocket.ts` | ✅ |
| P2-24 | 调试侧栏缺少任务分组 | `TerminalSidebar.tsx` | ⬜ |
| P2-25 | 调试侧栏缺少合并终端 | `TerminalSidebar.tsx` | ⬜ |
| P2-26~34 | 其他 Provider/Store/事件类型细节 | 多文件 | ⬜ |

---

## 3. 修复方案

### 3.1 P0 修复方案

#### P0-1: 终端数量可配置

**当前代码:**
```typescript
// Step2Tasks.tsx:8
const TERMINAL_COUNT_OPTIONS = [1, 2, 3];
```

**修复方案:**
- 用配置项或用户输入替代固定 1/2/3 选项
- UI 支持范围校验与上限提示（建议 1-10）
- 添加"更多"选项允许自定义输入

#### P0-2: 调试视图 PTY/xterm 交互

**当前代码:**
```typescript
// TerminalDebugView.tsx - 仅展示详情面板
```

**修复方案:**
- 引入已有的 `TerminalEmulator.tsx` 组件（xterm.js）
- 接入 PTY WebSocket 流 (`/terminal/:id`)
- 支持输入、复制、滚动、会话复用
- 复用 Phase 7 已实现的 xterm 基础设施

#### P0-3: 看板拖拽

**当前代码:**
```typescript
// WorkflowKanbanBoard.tsx - 静态渲染
```

**修复方案:**
- 引入 `@dnd-kit/core` 和 `@dnd-kit/sortable`
- 实现列内/跨列拖拽排序
- 拖拽完成后调用 API 更新任务状态
- 添加拖拽视觉反馈

#### P0-4: WebSocket 架构对齐

**当前代码:**
```typescript
// websocket.ts - 仅 input/output/resize/error
```

**修复方案:**
- 按设计拆分连接层/事件层/消息层
- 统一消息协议: `{type, payload, timestamp, id}`
- 添加事件类型: `workflow.*`, `terminal.*`, `git.*`, `orchestrator.*`, `system.*`
- 实现断线重连与心跳机制

#### P0-5: Zustand 状态管理

**当前代码:**
```
// frontend/src/stores/ - 目录为空
```

**修复方案:**
- 创建 store 结构与切片划分:
  - `workflowStore.ts` - 工作流状态
  - `terminalStore.ts` - 终端状态与输出
  - `wizardStore.ts` - 向导表单数据
  - `modelStore.ts` - 模型配置
  - `wsStore.ts` - WebSocket 连接
  - `uiStore.ts` - UI 状态
- 替换局部 state 和散落的 context
- 连接到 UI 与数据流

#### P0-6: Step3 API 调用补全

**当前代码:**
```typescript
// Step3Models.tsx:138-142
// TODO: Implement actual API call to fetch models
```

**修复方案:**
- 实现 `/api/models/list` 获取可用模型
- 实现 `/api/models/verify` 验证连接
- 添加错误处理与重试策略
- 更新 `isVerified` 状态

#### P0-7: CLI 扩展到 9 个

**当前代码:**
```typescript
// constants.ts - 仅 3 个 CLI
export const CLI_TYPES = {
  'claude-code': {...},
  'gemini-cli': {...},
  'codex': {...},
};
```

**修复方案:**
- 补齐设计文档 Appendix A 的 9 个 CLI:
  - Claude Code, Gemini CLI, Codex, Amp, Cursor Agent, Qwen Code, Copilot, Droid, Opencode
- 更新 UI 与校验逻辑支持新增项
- 同步后端 CLI 检测服务

---

### 3.2 P1 修复方案

#### P1-1: Git 提交规范对齐

- 替换 Conventional Commit 为设计的 METADATA 格式
- UI 中提供元数据字段与自动组装
- 更新 `GIT_COMMIT_FORMAT` 常量

#### P1-2: 路由结构对齐

- 改为 `/wizard/project`, `/wizard/basic`, `/wizard/tasks` 等分步路由
- 统一入口守卫与参数继承
- 支持 URL 直接定位到具体步骤

#### P1-3: 设置页面结构对齐

- 添加 `/settings/cli`, `/settings/models`, `/settings/presets` 路由
- 按设计分区与交互层级重构

#### P1-4: 视图切换导航

- 在 `NewDesignLayout` 添加全局视图切换入口 [看板][流水线][调试]
- 支持持久化用户上次视图

#### P1-5: 终端活动面板功能补全

- 仅显示 Working/Waiting 状态的终端
- 显示最近 3-5 行输出
- 添加可折叠功能
- 显示最后更新时间

#### P1-6: 流水线视图信息补全

- 任务头显示任务名 + 分支
- 终端节点显示状态图标 + 命令 + 连接线
- Merge Terminal 显示 CLI + 模型 + 状态

#### P1-7: Step4/Step5 交互对齐

- Step4: 未安装 CLI 可选但阻止下一步，提供安装命令与重检按钮
- Step5: 实现拖拽排序替代上下按钮

---

### 3.3 P2 修复方案

批量处理 UI/UX 细节:
- 去掉硬编码状态/文案，接入统一文案或配置
- 增补缺失提示、空状态、loading 与 error
- 按设计调整按钮状态/样式/可达性

---

## 4. 实施顺序

### 阶段 1: 架构与状态（P0-4, P0-5）

**优先级:** 最高
**原因:** 先落地 WebSocket 架构与 Zustand，否则后续功能易返工

| Task | 描述 |
|------|------|
| 18.5.1 | 创建 Zustand stores 目录结构与基础 store |
| 18.5.2 | 实现 wsStore WebSocket 连接管理 |
| 18.5.3 | 对齐 WebSocket 消息协议与事件类型 |
| 18.5.4 | 实现心跳机制与断线重连 |

### 阶段 2: 交互核心（P0-1, P0-2, P0-3）

**优先级:** 高
**原因:** 终端、调试、看板是主流程核心

| Task | 描述 |
|------|------|
| 18.5.5 | 终端数量可配置（Step2Tasks） |
| 18.5.6 | 调试视图接入 xterm.js PTY 交互 |
| 18.5.7 | 看板实现 dnd-kit 拖拽功能 |

### 阶段 3: 流程打通（P0-6, P0-7）

**优先级:** 高
**原因:** Step3 与 CLI 扩展恢复可用性

| Task | 描述 |
|------|------|
| 18.5.8 | Step3 实现真实 API 获取/验证模型 |
| 18.5.9 | CLI 类型扩展到 9 个 |

### 阶段 4: 流程一致性（P1-1 ~ P1-7）

**优先级:** 中
**原因:** 保证路由/提交/设置/视图一致

| Task | 描述 |
|------|------|
| 18.5.10 | Git 提交规范对齐 METADATA 格式 |
| 18.5.11 | 路由结构改为分步路由 |
| 18.5.12 | 设置页面结构对齐 |
| 18.5.13 | 视图切换导航补齐 |
| 18.5.14 | 终端活动面板功能补全 |
| 18.5.15 | 流水线视图信息补全 |
| 18.5.16 | Step4/Step5 交互对齐 |

### 阶段 5: 体验补齐（P2 15-48）

**优先级:** 低
**原因:** 批量修复 UI/UX 细节

| Task | 描述 |
|------|------|
| 18.5.17 | StatusBar/OrchestratorHeader 动态数据 |
| 18.5.18 | TaskCard/TerminalDots 状态区分 |
| 18.5.19 | Step0-Step6 UI 细节对齐 |
| 18.5.20 | 调试视图 UI 补全 |
| 18.5.21 | 流水线视图 UI 补全 |

---

## 5. 验收标准

### 5.1 功能验收

- [x] 终端数量支持 1-10 自定义
- [x] 调试视图可进行 PTY 交互
- [x] 看板支持拖拽任务卡片
- [x] WebSocket 消息协议符合设计
- [x] Zustand stores 正常工作
- [x] Step3 可真实获取/验证模型
- [x] 支持 9 个 CLI 类型

### 5.2 测试验收

- [ ] 所有现有测试通过
- [ ] 新增功能有对应测试
- [ ] E2E 测试覆盖核心流程

### 5.3 文档验收

- [ ] 更新 CHANGELOG
- [ ] 更新用户文档（如有影响）

---

## 6. 风险与依赖

### 6.1 风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| Zustand 迁移影响现有功能 | 高 | 渐进式迁移，保留兼容层 |
| dnd-kit 与现有样式冲突 | 中 | 隔离拖拽样式 |
| WebSocket 协议变更影响后端 | 高 | 前后端同步修改 |

### 6.2 依赖

- 需要后端配合修改 WebSocket 协议
- 需要后端实现 `/api/models/list` 和 `/api/models/verify` API
- 需要后端扩展 CLI 检测服务支持 9 个 CLI

---

## 7. 参考文档

- 设计文档: `docs/developed/plans/2026-01-16-orchestrator-design.md`
- 偏差审计: 2026-01-31 Codex + Claude 联合审计
- 相关 Phase: Phase 7 (xterm.js), Phase 16 (前端体验)
